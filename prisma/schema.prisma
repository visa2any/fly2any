// This is your Prisma schema file for Fly2Any Travel Platform
// Learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_URL")
}

// ==========================================
// NextAuth.js Required Models
// ==========================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String? // For email/password auth (hashed)

  // Profile fields
  firstName   String?
  lastName    String?
  phone       String?
  dateOfBirth DateTime?
  gender      String?
  country     String?
  timezone    String?
  bio         String?
  avatarUrl   String?

  // Metadata
  profileCompleted Boolean @default(false)

  // TripMatch Credits (Travel Rewards System)
  tripMatchCredits        Int @default(0) // Available credits
  tripMatchLifetimeEarned Int @default(0) // Total earned (all-time)
  tripMatchLifetimeSpent  Int @default(0) // Total redeemed (all-time)
  tripMatchPendingCredits Int @default(0) // Pending/processing credits
  tripMatchTier           String? // bronze, silver, gold, platinum
  tripMatchBonusMultiplier Float @default(1.0) // 1.0 = 100%, 1.5 = 150% bonus

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  // Relations
  accounts          Account[]
  sessions          Session[]
  savedSearches     SavedSearch[]
  priceAlerts       PriceAlert[]
  preferences       UserPreferences?
  recentSearches    RecentSearch[]
  aiConversations   AIConversation[]
  userSessions      UserSession[]
  loginHistory      LoginHistory[]
  notifications     Notification[]
  wishlistItems     WishlistItem[]
  pushSubscriptions PushSubscription[]
  adminUser         AdminUser?

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ==========================================
// User Preferences & Personalization
// ==========================================

model UserPreferences {
  id     String @id @default(cuid())
  userId String @unique

  // Travel preferences
  preferredCabinClass String? // economy, premium, business, first
  preferredAirlines   String[] // ['AA', 'UA', 'DL']
  homeAirport         String? // 'JFK'

  // Notification preferences
  emailNotifications Boolean @default(true)
  priceAlertEmails   Boolean @default(true)
  dealAlerts         Boolean @default(true)
  newsletterOptIn    Boolean @default(false)

  // UI preferences
  currency String @default("USD")
  language String @default("en")
  theme    String @default("light") // light, dark, auto

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

// ==========================================
// Saved Searches & Price Alerts
// ==========================================

model SavedSearch {
  id     String @id @default(cuid())
  userId String
  name   String

  // Search parameters
  origin      String
  destination String
  departDate  String
  returnDate  String?
  adults      Int     @default(1)
  children    Int     @default(0)
  infants     Int     @default(0)
  cabinClass  String  @default("economy")

  // Additional filters (stored as JSON)
  filters Json?

  // Metadata
  searchCount  Int      @default(1)
  lastSearched DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, lastSearched])
  @@map("saved_searches")
}

model PriceAlert {
  id     String @id @default(cuid())
  userId String

  // Route details
  origin      String
  destination String
  departDate  String
  returnDate  String?

  // Price tracking
  currentPrice Float
  targetPrice  Float
  currency     String @default("USD")

  // Alert status
  active      Boolean   @default(true)
  triggered   Boolean   @default(false)
  lastChecked DateTime  @default(now())
  triggeredAt DateTime?

  // Notification tracking
  lastNotifiedAt    DateTime?
  notificationCount Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, active])
  @@index([active])
  @@map("price_alerts")
}

// ==========================================
// Recent Searches (for logged-in users)
// ==========================================

model RecentSearch {
  id     String @id @default(cuid())
  userId String

  // Destination details
  city        String
  country     String
  airportCode String
  imageUrl    String?

  // Flight details
  origin        String?
  price         Float
  originalPrice Float?

  // Trip dates
  departDate String?
  returnDate String?

  // Metadata
  viewedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, viewedAt])
  @@map("recent_searches")
}

// ==========================================
// Analytics & Tracking
// ==========================================

model UserActivity {
  id     String  @id @default(cuid())
  userId String?

  // Activity details
  eventType String // search, view, click, book, etc.
  eventData Json?

  // Context
  ipAddress String?
  userAgent String?
  referrer  String?

  createdAt DateTime @default(now())

  @@index([userId, createdAt])
  @@index([eventType, createdAt])
  @@map("user_activities")
}

// ==========================================
// AI Conversation Persistence System
// ==========================================

model AIConversation {
  id        String  @id @default(cuid())
  sessionId String  @unique // UUID from localStorage
  userId    String? // Nullable - can be anonymous initially

  // Conversation status
  status String @default("active") // active, completed, abandoned

  // Current state
  currentConsultantTeam String?
  conversationContext   Json? // Flexible storage for conversation state
  searchHistory         Json? // Array of search queries performed

  // Metadata (stored as JSON for flexibility)
  metadata Json // { startedAt, lastMessageAt, completedAt, messageCount, platform, browser }

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  messages AIMessage[]
  user     User?       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionId])
  @@index([status])
  @@index([createdAt])
  @@map("ai_conversations")
}

model AIMessage {
  id             String @id @default(cuid())
  conversationId String

  // Message content
  role    String // user, assistant
  content String @db.Text

  // Consultant info (for assistant messages)
  consultantName  String?
  consultantTeam  String?
  consultantEmoji String?

  // Search results attached to message
  flightResults Json? // Array of flight results
  hotelResults  Json? // Array of hotel results

  // Timing
  timestamp BigInt // Unix timestamp from client
  createdAt DateTime @default(now())

  // Relations
  conversation AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([conversationId, timestamp])
  @@map("ai_messages")
}

// ==========================================
// User Sessions & Security
// ==========================================

model UserSession {
  id         String   @id @default(cuid())
  userId     String
  token      String   @unique
  device     String?
  browser    String?
  os         String?
  location   String?
  ipAddress  String?
  lastActive DateTime @default(now())
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, lastActive])
  @@map("user_sessions")
}

model LoginHistory {
  id        String   @id @default(cuid())
  userId    String
  device    String?
  browser   String?
  os        String?
  location  String?
  ipAddress String?
  success   Boolean  @default(true)
  timestamp DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, timestamp])
  @@map("login_history")
}

// ==========================================
// Price Monitoring System
// ==========================================

model PriceHistory {
  id          String   @id @default(cuid())
  origin      String
  destination String
  departDate  String
  returnDate  String?
  price       Float
  currency    String   @default("USD")
  provider    String // "duffel", "amadeus", or "mock"
  timestamp   DateTime @default(now())

  @@index([origin, destination, departDate])
  @@index([timestamp])
  @@map("price_history")
}

model PriceMonitorLog {
  id              String   @id @default(cuid())
  executionTime   DateTime @default(now())
  alertsChecked   Int
  alertsTriggered Int
  alertsFailed    Int
  errors          Json?
  duration        Int // milliseconds
  triggeredBy     String // "cron" or "manual"

  @@index([executionTime])
  @@map("price_monitor_logs")
}

// ==========================================
// Wishlist & User Engagement
// ==========================================

model WishlistItem {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Flight details (stored as JSON for flexibility)
  flightData Json // Complete flight information

  // User customization
  notes        String? @db.Text
  targetPrice  Float?
  notifyOnDrop Boolean @default(true)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([userId, createdAt])
  @@map("wishlist_items")
}

// ==========================================
// PWA Push Notifications
// ==========================================

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  endpoint  String   @unique
  p256dh    String
  auth      String
  userAgent String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@map("push_subscriptions")
}

// ==========================================
// Notification System
// ==========================================

model Notification {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String // 'booking', 'price_alert', 'system', 'promotion'
  title     String
  message   String    @db.Text
  priority  String    @default("medium") // 'low', 'medium', 'high', 'urgent'
  read      Boolean   @default(false)
  actionUrl String?
  metadata  Json?
  createdAt DateTime  @default(now())
  readAt    DateTime?

  @@index([userId, read])
  @@index([createdAt])
  @@map("notifications")
}

// ==========================================
// Phase 8: Analytics & Business Intelligence
// ==========================================

// Analytics Events - Raw event tracking
model AnalyticsEvent {
  id        String  @id @default(cuid())
  userId    String?
  sessionId String
  eventType String // page_view, search, click, booking, conversion, etc.
  eventData Json // Flexible storage for event-specific data

  // Context
  url       String?
  referrer  String?
  userAgent String?
  ipAddress String?

  timestamp DateTime @default(now())

  @@index([eventType, timestamp])
  @@index([userId, timestamp])
  @@index([sessionId, timestamp])
  @@index([timestamp]) // For time-range queries
  @@map("analytics_events")
}

// Aggregated Metrics - Pre-calculated for dashboard performance
model MetricSnapshot {
  id          String   @id @default(cuid())
  metricName  String // dau, searches, conversions, revenue, etc.
  value       Float
  dimensions  Json // {route: "NYC-LAX", date: "2025-01-01", segment: "mobile"}
  timestamp   DateTime @default(now())
  granularity String // hourly, daily, weekly, monthly

  @@unique([metricName, granularity, timestamp])
  @@index([metricName, timestamp])
  @@index([timestamp, granularity])
  @@map("metric_snapshots")
}

// ML Price Predictions
model PricePrediction {
  id             String  @id @default(cuid())
  origin         String
  destination    String
  departDate     String
  returnDate     String?
  predictedPrice Float
  confidence     Float // 0.0 to 1.0
  priceRange     Json // {min: 450, max: 650}
  modelVersion   String
  features       Json // Feature values used for prediction

  // Recommendation
  recommendation  String? // "book_now", "wait", "flexible_dates"
  savingsEstimate Float?

  createdAt DateTime @default(now())
  expiresAt DateTime // Predictions valid for limited time

  @@index([origin, destination, departDate])
  @@index([createdAt])
  @@map("price_predictions")
}

// ML Model Metadata
model MLModel {
  id        String @id @default(cuid())
  name      String @unique
  version   String
  modelType String // regression, classification, etc.
  accuracy  Float? // Model performance metrics
  metrics   Json // {rmse: 45.2, mae: 32.1, r2: 0.85}

  // Training info
  trainedAt    DateTime
  trainingData Json // Summary of training data
  features     String[] // Feature names used

  // Deployment
  active     Boolean   @default(false)
  deployedAt DateTime?

  createdAt DateTime @default(now())

  @@index([name, version])
  @@index([active])
  @@map("ml_models")
}

// Feature Flags & A/B Testing
model FeatureFlag {
  id                String  @id @default(cuid())
  key               String  @unique
  name              String
  description       String?
  enabled           Boolean @default(false)
  rolloutPercentage Int     @default(0) // 0-100
  targetSegments    Json? // User segments to target
  variants          Json // [{id: "control", weight: 50}, {id: "variant_a", weight: 50}]

  // Experiment tracking
  isExperiment      Boolean @default(false)
  experimentStatus  String? // draft, running, completed, archived
  successMetric     String? // Metric to optimize
  minimumSampleSize Int?

  // Results
  experimentResults Json?
  winningVariant    String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  startedAt   DateTime?
  completedAt DateTime?

  participations ExperimentParticipation[]

  @@index([key])
  @@index([enabled])
  @@index([isExperiment, experimentStatus])
  @@map("feature_flags")
}

// Experiment Participation Tracking
model ExperimentParticipation {
  id         String   @id @default(cuid())
  flagId     String
  userId     String?
  sessionId  String
  variant    String
  assignedAt DateTime @default(now())

  // Conversion tracking
  converted       Boolean   @default(false)
  convertedAt     DateTime?
  conversionValue Float?

  flag FeatureFlag @relation(fields: [flagId], references: [id], onDelete: Cascade)

  @@unique([flagId, userId])
  @@unique([flagId, sessionId])
  @@index([flagId, variant])
  @@index([flagId, converted])
  @@map("experiment_participations")
}

// Performance Metrics (Web Vitals)
model PerformanceMetric {
  id         String @id @default(cuid())
  metricName String // LCP, FID, CLS, FCP, TTI, TTFB
  value      Float
  rating     String // good, needs-improvement, poor

  // Context
  url       String
  userId    String?
  sessionId String

  // Environment
  deviceType     String? // mobile, tablet, desktop
  browser        String?
  browserVersion String?
  os             String?
  connectionType String? // 4g, 3g, wifi

  timestamp DateTime @default(now())

  @@index([metricName, timestamp])
  @@index([url, metricName])
  @@index([rating, metricName])
  @@index([timestamp])
  @@map("performance_metrics")
}

// Error Tracking
model ErrorLog {
  id        String  @id @default(cuid())
  message   String  @db.Text
  stack     String? @db.Text
  errorType String? // TypeError, ReferenceError, etc.

  // Context
  url       String
  userId    String?
  sessionId String

  // Environment
  userAgent String?
  browser   String?
  os        String?

  // Metadata
  severity   String // error, warning, info
  resolved   Boolean   @default(false)
  resolvedAt DateTime?
  resolvedBy String?
  notes      String?   @db.Text

  // Grouping (for similar errors)
  fingerprint String? // Hash of error for grouping
  count       Int     @default(1)

  timestamp DateTime @default(now())

  @@index([severity, resolved, timestamp])
  @@index([fingerprint, timestamp])
  @@index([userId])
  @@index([timestamp])
  @@map("error_logs")
}

// Conversion Funnel Tracking
model ConversionFunnel {
  id        String  @id @default(cuid())
  sessionId String
  userId    String?

  // Funnel stages
  stage  String // search, results, details, booking, payment, confirmation
  action String // entered, completed, abandoned

  // Context
  metadata Json? // Route, price, filters, etc.
  duration Int? // Time spent in stage (ms)

  timestamp DateTime @default(now())

  @@index([sessionId, stage])
  @@index([stage, action, timestamp])
  @@index([timestamp])
  @@map("conversion_funnels")
}

// User Cohorts for Retention Analysis
model UserCohort {
  id          String   @id @default(cuid())
  userId      String
  cohortDate  DateTime // First signup/activity date
  cohortWeek  String // "2025-W01"
  cohortMonth String // "2025-01"

  // Activity tracking
  lastActiveAt DateTime

  // Retention flags
  day1Retained  Boolean @default(false)
  day7Retained  Boolean @default(false)
  day30Retained Boolean @default(false)

  // Engagement
  totalSessions Int   @default(0)
  totalSearches Int   @default(0)
  totalBookings Int   @default(0)
  lifetimeValue Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId])
  @@index([cohortDate])
  @@index([cohortWeek])
  @@index([cohortMonth])
  @@map("user_cohorts")
}

// ==========================================
// Phase 9: Admin Dashboard & CMS
// ==========================================

// Admin User Roles
model AdminUser {
  id     String @id @default(cuid())
  userId String @unique

  role        String // 'super_admin', 'admin', 'moderator'
  permissions Json? // Custom permissions override

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([role])
  @@map("admin_users")
}

// Audit Trail for Admin Actions
model AuditLog {
  id        String @id @default(cuid())
  userId    String
  userEmail String
  userRole  String

  action     String // 'create', 'update', 'delete', 'view'
  resource   String // 'user', 'deal', 'experiment', etc.
  resourceId String
  changes    Json?

  ipAddress String?
  userAgent String?
  requestId String?

  success      Boolean @default(true)
  errorMessage String?

  timestamp DateTime @default(now())

  @@index([userId, timestamp])
  @@index([resource, resourceId])
  @@index([timestamp])
  @@index([action, resource])
  @@map("audit_logs")
}

// Travel Deals Content
model Deal {
  id   String @id @default(cuid())
  slug String @unique

  title       String
  description String @db.Text

  destination Json // {city, country, airportCode}
  origin      String

  originalPrice   Float
  discountedPrice Float
  currency        String @default("USD")

  flightDetails Json // {airline, flightNumber, duration, stops, departDate, returnDate, etc}

  dealScore Int       @default(50)
  featured  Boolean   @default(false)
  active    Boolean   @default(true)
  expiresAt DateTime?

  category String   @default("featured") // flash_sale, last_minute, featured, seasonal
  tags     String[]

  images       Json // {thumbnail, hero, gallery}
  restrictions String[]

  seo Json // {metaTitle, metaDescription, keywords}

  // Analytics
  views       Int @default(0)
  clicks      Int @default(0)
  conversions Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String

  @@index([slug])
  @@index([active, featured])
  @@index([expiresAt])
  @@index([category])
  @@map("deals")
}

// Destinations Content
model Destination {
  id          String @id @default(cuid())
  slug        String @unique
  airportCode String @unique

  city    String
  country String
  region  String

  description      String   @db.Text
  shortDescription String
  highlights       String[]

  travelInfo   Json // {bestTimeToVisit, climate, activities, avgTemp, etc}
  priceRange   String // 'budget', 'moderate', 'luxury'
  avgPrice     Float?
  travelStyles String[] // beach, adventure, culture, food, romantic, etc

  images Json // {hero, gallery, video}

  seo Json // {metaTitle, metaDescription, keywords}

  published Boolean @default(false)
  featured  Boolean @default(false)
  trending  Boolean @default(false)

  // Analytics
  views    Int @default(0)
  searches Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([airportCode])
  @@index([published, featured])
  @@index([trending])
  @@map("destinations")
}

// Email Templates
model EmailTemplate {
  id   String @id @default(cuid())
  name String @unique
  key  String @unique // Internal key for referencing

  subject   String
  preheader String?
  body      String  @db.Text
  variables Json // [{name, type, default}]

  layout      String  @default("default") // default, marketing, transactional
  brandColor  String  @default("#3b82f6")
  headerImage String?
  footerText  String  @default("Â© 2025 Fly2Any. All rights reserved.")

  active Boolean @default(true)

  // Testing
  lastTested      DateTime?
  testRecipients  String[]
  testsSent       Int       @default(0)
  lastTestResults Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
  @@index([active])
  @@map("email_templates")
}

// System Health Monitoring
model HealthCheck {
  id String @id @default(cuid())

  service String // 'database', 'api', 'external:duffel', 'external:amadeus', etc
  status  String // 'healthy', 'degraded', 'down'

  responseTime Float?
  errorMessage String?
  metadata     Json?

  timestamp DateTime @default(now())

  @@index([service, timestamp])
  @@index([status, timestamp])
  @@map("health_checks")
}

// Search Autocomplete Cache
model SearchSuggestion {
  id String @id @default(cuid())

  query      String  @unique
  type       String // 'airport', 'city', 'country'
  code       String? // Airport code
  name       String
  country    String?
  popularity Int     @default(0)

  metadata Json? // Additional data (coordinates, timezone, etc)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([query])
  @@index([type, popularity])
  @@map("search_suggestions")
}
