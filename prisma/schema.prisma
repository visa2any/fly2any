// This is your Prisma schema file for Fly2Any Travel Platform
// Learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_URL")
}

// ==========================================
// NextAuth.js Required Models
// ==========================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String? // For email/password auth (hashed)

  // Profile fields
  firstName   String?
  lastName    String?
  phone       String?
  dateOfBirth DateTime?
  gender      String?
  country     String?
  timezone    String?
  bio         String?
  avatarUrl   String?

  // Metadata
  profileCompleted Boolean @default(false)

  // TripMatch Credits (Travel Rewards System - Group Travel)
  tripMatchCredits         Int     @default(0) // Available credits
  tripMatchLifetimeEarned  Int     @default(0) // Total earned (all-time)
  tripMatchLifetimeSpent   Int     @default(0) // Total redeemed (all-time)
  tripMatchPendingCredits  Int     @default(0) // Pending/processing credits
  tripMatchTier            String? // bronze, silver, gold, platinum
  tripMatchBonusMultiplier Float   @default(1.0) // 1.0 = 100%, 1.5 = 150% bonus

  // Fly2Any Rewards Points (Tiered Travel Rewards Program)
  fly2anyPoints         Int @default(0) // Available points (unlocked)
  fly2anyPointsLocked   Int @default(0) // Locked points (pending trip completion)
  fly2anyPointsLifetime Int @default(0) // Total earned (all-time)
  fly2anyPointsRedeemed Int @default(0) // Total spent (all-time)

  // LiteAPI Integration (Hotels Loyalty)
  liteApiGuestId        String? @unique // LiteAPI guest ID for hotel loyalty sync
  hotelPointsBalance    Int     @default(0) // Points from hotel bookings (via LiteAPI)
  hotelPointsPending    Int     @default(0) // Pending hotel points (before checkout)

  // Referral Network
  referralCode         String? @unique // User's unique referral code
  referredBy           String? // ID of user who referred them
  referralLevel        Int     @default(0) // Depth in referral tree (0 = top)
  directReferralsCount Int     @default(0) // Level 1 count
  totalNetworkSize     Int     @default(0) // All levels combined

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  // Relations
  accounts          Account[]
  sessions          Session[]
  savedSearches     SavedSearch[]
  priceAlerts       PriceAlert[]
  preferences       UserPreferences?
  recentSearches    RecentSearch[]
  aiConversations   AIConversation[]
  userSessions      UserSession[]
  loginHistory      LoginHistory[]
  notifications     Notification[]
  wishlistItems     WishlistItem[]
  pushSubscriptions PushSubscription[]
  adminUser         AdminUser?
  createdTrips      TripGroup[]        @relation("TripCreator")
  groupMemberships  GroupMember[]      @relation("GroupMemberships")
  frequentTravelers FrequentTraveler[]
  paymentMethods    PaymentMethod[]
  travelDocuments   TravelDocument[]
  affiliate         Affiliate?         @relation("UserAffiliate")
  travelAgent       TravelAgent?          @relation("UserTravelAgent")
  agentClient       AgentClient?          @relation("UserAgentClient")
  worldCupBookings  WorldCupBooking[]
  tripMatchProfile  TripMatchUserProfile? @relation("TripMatchProfile")
  promoCodeUsages   PromoCodeUsage[]

  // Referral Points Relations
  pointsEarned       ReferralPointsTransaction[] @relation("PointsEarner")
  pointsFromBookings ReferralPointsTransaction[] @relation("PointsCustomer")

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ==========================================
// User Preferences & Personalization
// ==========================================

model UserPreferences {
  id     String @id @default(cuid())
  userId String @unique

  // Travel preferences
  preferredCabinClass String? // economy, premium, business, first
  preferredAirlines   String[] // ['AA', 'UA', 'DL']
  homeAirport         String? // 'JFK'

  // Notification preferences
  emailNotifications Boolean @default(true)
  priceAlertEmails   Boolean @default(true)
  dealAlerts         Boolean @default(true)
  newsletterOptIn    Boolean @default(false)
  notifications      Json? // Advanced notification settings {email: true, push: true, sms: false, ...}

  // UI preferences
  currency String @default("USD")
  language String @default("en")
  theme    String @default("light") // light, dark, auto

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

// ==========================================
// Saved Searches & Price Alerts
// ==========================================

model SavedSearch {
  id     String @id @default(cuid())
  userId String
  name   String

  // Search parameters
  origin      String
  destination String
  departDate  String
  returnDate  String?
  adults      Int     @default(1)
  children    Int     @default(0)
  infants     Int     @default(0)
  cabinClass  String  @default("economy")

  // Additional filters (stored as JSON)
  filters Json?

  // Metadata
  searchCount  Int      @default(1)
  lastSearched DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, lastSearched])
  @@map("saved_searches")
}

model PriceAlert {
  id     String @id @default(cuid())
  userId String

  // Route details
  origin      String
  destination String
  departDate  String
  returnDate  String?

  // Price tracking
  currentPrice Float
  targetPrice  Float
  currency     String @default("USD")

  // Alert status
  active      Boolean   @default(true)
  triggered   Boolean   @default(false)
  lastChecked DateTime  @default(now())
  triggeredAt DateTime?

  // Notification tracking
  lastNotifiedAt    DateTime?
  notificationCount Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, active])
  @@index([active])
  @@map("price_alerts")
}

// ==========================================
// Recent Searches (for logged-in users)
// ==========================================

model RecentSearch {
  id     String @id @default(cuid())
  userId String

  // Destination details
  city        String
  country     String
  airportCode String
  imageUrl    String?

  // Flight details
  origin        String?
  price         Float
  originalPrice Float?

  // Trip dates
  departDate String?
  returnDate String?

  // Metadata
  createdAt DateTime @default(now()) // When search was created
  viewedAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, viewedAt])
  @@map("recent_searches")
}

// ==========================================
// Analytics & Tracking
// ==========================================

model UserActivity {
  id     String  @id @default(cuid())
  userId String?

  // Activity details
  eventType String // search, view, click, book, etc.
  eventData Json?

  // Context
  ipAddress String?
  userAgent String?
  referrer  String?

  createdAt DateTime @default(now())

  @@index([userId, createdAt])
  @@index([eventType, createdAt])
  @@map("user_activities")
}

// ==========================================
// AI Conversation Persistence System
// ==========================================

model AIConversation {
  id        String  @id @default(cuid())
  sessionId String  @unique // UUID from localStorage
  userId    String? // Nullable - can be anonymous initially

  // Conversation status
  status String @default("active") // active, completed, abandoned

  // Current state
  currentConsultantTeam String?
  conversationContext   Json? // Flexible storage for conversation state
  searchHistory         Json? // Array of search queries performed

  // Metadata (stored as JSON for flexibility)
  metadata Json // { startedAt, lastMessageAt, completedAt, messageCount, platform, browser }

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  messages AIMessage[]
  user     User?       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionId])
  @@index([status])
  @@index([createdAt])
  @@map("ai_conversations")
}

model AIMessage {
  id             String @id @default(cuid())
  conversationId String

  // Message content
  role    String // user, assistant
  content String @db.Text

  // Consultant info (for assistant messages)
  consultantName  String?
  consultantTeam  String?
  consultantEmoji String?

  // Search results attached to message
  flightResults Json? // Array of flight results
  hotelResults  Json? // Array of hotel results

  // Timing
  timestamp BigInt // Unix timestamp from client
  createdAt DateTime @default(now())

  // Relations
  conversation AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([conversationId, timestamp])
  @@map("ai_messages")
}

// ==========================================
// User Sessions & Security
// ==========================================

model UserSession {
  id         String   @id @default(cuid())
  userId     String
  token      String   @unique
  device     String?
  browser    String?
  os         String?
  location   String?
  ipAddress  String?
  lastActive DateTime @default(now())
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, lastActive])
  @@map("user_sessions")
}

model LoginHistory {
  id        String   @id @default(cuid())
  userId    String
  device    String?
  browser   String?
  os        String?
  location  String?
  ipAddress String?
  success   Boolean  @default(true)
  timestamp DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, timestamp])
  @@map("login_history")
}

// ==========================================
// Price Monitoring System
// ==========================================

model PriceHistory {
  id          String   @id @default(cuid())
  origin      String
  destination String
  departDate  String
  returnDate  String?
  price       Float
  currency    String   @default("USD")
  provider    String // "duffel", "amadeus", or "mock"
  timestamp   DateTime @default(now())

  @@index([origin, destination, departDate])
  @@index([timestamp])
  @@map("price_history")
}

model PriceMonitorLog {
  id              String   @id @default(cuid())
  executionTime   DateTime @default(now())
  alertsChecked   Int
  alertsTriggered Int
  alertsFailed    Int
  errors          Json?
  duration        Int // milliseconds
  triggeredBy     String // "cron" or "manual"

  @@index([executionTime])
  @@map("price_monitor_logs")
}

// ==========================================
// Wishlist & User Engagement
// ==========================================

model WishlistItem {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Product type (supports multiple products)
  productType String @default("flight") // flight, hotel, car, activity
  productId   String? // External product ID (hotel ID, etc.)

  // Product details (stored as JSON for flexibility)
  flightData Json? // Flight information (legacy + new flights)
  hotelData  Json? // Hotel information (new)
  productData Json? // Generic product data

  // User customization
  notes        String? @db.Text
  targetPrice  Float?
  notifyOnDrop Boolean @default(true)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([userId, productType])
  @@index([userId, createdAt])
  @@map("wishlist_items")
}

// ==========================================
// Loyalty & Voucher System
// ==========================================

model LoyaltyTransaction {
  id        String   @id @default(cuid())
  userId    String

  // Transaction details
  type        String   // earn, redeem, expire, adjust, welcome_bonus
  source      String   // hotel, flight, car, activity, referral, promo, admin
  points      Int      // Positive for earn, negative for redeem
  description String

  // Booking reference (if applicable)
  bookingType      String?  // hotel, flight, etc.
  bookingReference String?  // Booking ID or reference
  bookingAmount    Float?   // Original booking amount

  // LiteAPI sync (for hotel transactions)
  liteApiTransactionId String? @unique

  // Metadata
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([userId, type])
  @@index([userId, source])
  @@index([userId, createdAt])
  @@map("loyalty_transactions")
}

model VoucherRedemption {
  id        String   @id @default(cuid())
  userId    String?  // Null for guest redemptions

  // Voucher details
  voucherCode    String
  voucherType    String   // percentage, fixed, freeNight
  discountValue  Float    // Original voucher value
  discountAmount Float    // Actual discount applied
  currency       String   @default("USD")

  // Booking reference
  bookingType      String   // hotel, flight, car, activity
  bookingReference String
  bookingAmount    Float    // Amount before discount
  finalAmount      Float    // Amount after discount

  // LiteAPI sync (for hotel vouchers)
  liteApiVoucherId String?

  // Metadata
  redeemedAt DateTime @default(now())

  @@index([userId])
  @@index([voucherCode])
  @@index([bookingReference])
  @@map("voucher_redemptions")
}

model PromoCode {
  id          String   @id @default(cuid())
  code        String   @unique

  // Discount configuration
  type        String   // percentage, fixed, freeNight
  value       Float    // Percentage (0-100) or fixed amount
  currency    String   @default("USD")

  // Restrictions
  minSpend       Float?   // Minimum booking amount
  maxDiscount    Float?   // Maximum discount cap
  usageLimit     Int?     // Total usage limit (null = unlimited)
  usageCount     Int      @default(0) // Current usage count
  perUserLimit   Int      @default(1) // Max uses per user

  // Targeting
  applicableProducts String[] // ["hotel", "flight", "all"]
  applicableHotels   String[] // Specific hotel IDs (empty = all)
  newUsersOnly       Boolean  @default(false)

  // Redemption Requirements
  requiresAccount    Boolean  @default(false) // User must be logged in
  requiresPWAApp     Boolean  @default(false) // User must have PWA app installed

  // Validity
  validFrom DateTime
  validUntil DateTime
  isActive   Boolean  @default(true)

  // Metadata
  description  String?
  internalNote String?
  createdBy    String?  // Admin user ID
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  usages PromoCodeUsage[]

  @@index([code])
  @@index([isActive, validFrom, validUntil])
  @@map("promo_codes")
}

// ==========================================
// Traveler Management (Phase 1 - Critical)
// ==========================================

model FrequentTraveler {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relationship to primary user
  relationship String? // self, spouse, child, parent, friend, colleague

  // Personal Information
  title       String? // Mr, Mrs, Ms, Dr, Prof
  firstName   String
  middleName  String?
  lastName    String
  dateOfBirth DateTime
  gender      String // male, female, other
  nationality String? // ISO country code

  // Travel Documents
  passportNumber  String?
  passportExpiry  DateTime?
  passportCountry String? // Issuing country

  // TSA/Security Numbers
  knownTravelerNumber String? // TSA PreCheck, Global Entry, Nexus
  redressNumber       String? // DHS Traveler Redress Inquiry Program

  // Loyalty Programs - Flexible JSON storage
  frequentFlyerNumbers Json? // {airline: "AA", number: "123456", tier: "Gold"}
  hotelLoyaltyNumbers  Json? // {chain: "Marriott", number: "789", tier: "Platinum"}

  // Contact (optional - for separate travelers)
  email String?
  phone String?

  // Preferences
  seatPreference String? // window, aisle, middle
  mealPreference String? // vegetarian, vegan, kosher, halal, etc.
  specialNeeds   String? @db.Text // wheelchair, oxygen, etc.

  // Metadata
  isDefault Boolean  @default(false) // Primary traveler for quick-fill
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([userId, isDefault])
  @@map("frequent_travelers")
}

// ==========================================
// Payment Methods (Phase 1 - Critical)
// ==========================================

model PaymentMethod {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Payment Type
  type     String // card, paypal, apple_pay, google_pay, bank_account
  provider String // stripe, paypal, etc.

  // Card Information (for card type)
  last4          String? // Last 4 digits
  brand          String? // visa, mastercard, amex, discover, jcb
  expiryMonth    Int?
  expiryYear     Int?
  cardholderName String?

  // Billing Address
  billingAddress Json? // {street, city, state, zip, country}

  // Provider Integration
  stripePaymentMethodId String? @unique // Stripe payment method ID
  paypalAccountId       String? @unique // PayPal account reference

  // Metadata
  isDefault Boolean @default(false)
  nickname  String? // e.g., "Personal Visa", "Business Amex"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([userId, isDefault])
  @@index([stripePaymentMethodId])
  @@map("payment_methods")
}

// ==========================================
// Travel Documents (Phase 1)
// ==========================================

model TravelDocument {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Document Type
  type String // passport, visa, national_id, driver_license, known_traveler

  // Document Details
  documentNumber String
  issuingCountry String // ISO country code
  firstName      String
  lastName       String
  middleName     String?

  // Dates
  issuedDate     DateTime?
  expirationDate DateTime

  // Optional file storage (encrypted URLs)
  frontImageUrl String? // Front of document
  backImageUrl  String? // Back of document (if applicable)

  // Visa-specific fields
  visaType           String? // tourist, business, student, work
  destinationCountry String? // For visas

  // Status
  isVerified Boolean @default(false) // Admin verification

  // Metadata
  notes     String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([userId, type])
  @@index([expirationDate]) // For expiration alerts
  @@map("travel_documents")
}

// ==========================================
// PWA Push Notifications
// ==========================================

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  endpoint  String   @unique
  p256dh    String
  auth      String
  userAgent String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@map("push_subscriptions")
}

// ==========================================
// Notification System
// ==========================================

model Notification {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String // 'booking', 'price_alert', 'system', 'promotion'
  title     String
  message   String    @db.Text
  priority  String    @default("medium") // 'low', 'medium', 'high', 'urgent'
  read      Boolean   @default(false)
  actionUrl String?
  metadata  Json?
  createdAt DateTime  @default(now())
  readAt    DateTime?

  @@index([userId, read])
  @@index([createdAt])
  @@map("notifications")
}

// ==========================================
// TripMatch Phase 2: Group Travel & Credits System
// ==========================================

// TripMatch Referral System
// =============================================
// FLY2ANY REWARDS - TIERED TRAVEL REWARDS PROGRAM
// =============================================

// Network Relationships (Who referred whom at what level)
model ReferralNetworkRelationship {
  id String @id @default(cuid())

  // Network Structure
  referrerId String // Person earning points
  refereeId  String // Person who was referred
  level      Int // 1, 2, or 3 (depth from referrer)

  // Status Tracking
  status String @default("pending")
  // pending → signed_up → first_booking → active → churned

  // Important Dates
  signupCompletedAt DateTime?
  firstBookingAt    DateTime?
  lastActivityAt    DateTime?
  createdAt         DateTime  @default(now())

  // Lifetime Value Tracking
  totalBookings     Int     @default(0)
  totalRevenue      Decimal @default(0) @db.Decimal(10, 2)
  totalPointsEarned Int     @default(0) // Points this relationship generated

  @@unique([referrerId, refereeId]) // Prevent duplicate relationships
  @@index([referrerId, level])
  @@index([refereeId])
  @@index([status])
  @@map("referral_network_relationships")
}

// Individual Points Transactions (Per Booking)
model ReferralPointsTransaction {
  id String @id @default(cuid())

  // The Booking
  bookingId     String // Reference to booking
  bookingAmount Decimal @db.Decimal(10, 2)
  productType   String // flight, hotel, package, car, activity
  productData   Json? // Flight details, hotel info, etc.

  // Who Earns Points
  earnerId   String // Referrer getting points
  customerId String // Customer who made booking
  level      Int // 1, 2, or 3

  // Points Calculation
  pointsRate        Int // Points per $100 (e.g., 50 for Level 1)
  productMultiplier Decimal @default(1.0) @db.Decimal(3, 2) // 1.0x, 1.2x, 1.5x, 2.0x
  pointsCalculated  Int // Total points awarded
  pointsAwarded     Int // Actual points (after any adjustments)

  // Status Lifecycle
  status String @default("locked")
  // locked → trip_in_progress → trip_completed → unlocked → expired

  // Trip Tracking (CRITICAL FOR ANTI-FRAUD)
  tripStartDate   DateTime?
  tripEndDate     DateTime?
  tripCompletedAt DateTime? // When trip successfully ended
  tripCancelled   Boolean   @default(false)
  tripCancelledAt DateTime?
  tripRefunded    Boolean   @default(false)

  // Points Unlocking
  pointsLockedAt   DateTime  @default(now())
  pointsUnlockedAt DateTime? // When points become available
  pointsExpireAt   DateTime? // Points can expire if not used

  // Usage
  pointsUsed   Boolean   @default(false)
  pointsUsedAt DateTime?
  pointsUsedIn String? // Booking ID where points were redeemed

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations (FK to User)
  earner   User @relation("PointsEarner", fields: [earnerId], references: [id], onDelete: Cascade)
  customer User @relation("PointsCustomer", fields: [customerId], references: [id], onDelete: Cascade)

  // CRITICAL: Unique constraint prevents duplicate point awards for same booking+earner+level
  @@unique([bookingId, earnerId, level], name: "unique_booking_earner_level")
  @@index([earnerId, status])
  @@index([customerId])
  @@index([bookingId])
  @@index([tripEndDate]) // For cron job to check completed trips
  @@index([pointsUnlockedAt])
  @@map("referral_points_transactions")
}

// Legacy Referral Model (Keep for backward compatibility)
model Referral {
  id         String    @id @default(cuid())
  referrerId String // User who shared the code
  refereeId  String? // User who used the code (nullable until claimed)
  code       String    @unique
  status     String    @default("pending") // pending, completed, expired
  rewardPaid Boolean   @default(false)
  usedAt     DateTime?
  createdAt  DateTime  @default(now())
  expiresAt  DateTime

  @@index([referrerId])
  @@index([refereeId])
  @@index([code])
  @@index([status])
  @@map("referrals")
}

// TripMatch Credit Transactions
model CreditTransaction {
  id          String    @id @default(cuid())
  userId      String
  type        String // earn, spend, refund, bonus, expired
  amount      Int // Credits (can be negative for spend)
  source      String // trip_booking, referral, bonus, purchase
  status      String    @default("completed") // pending, completed, failed, reversed
  description String?
  metadata    Json? // Additional context (tripId, memberId, etc)
  createdAt   DateTime  @default(now())
  processedAt DateTime?

  @@index([userId, createdAt])
  @@index([type, createdAt])
  @@index([status])
  @@map("credit_transactions")
}

// TripMatch Group Trips
model TripGroup {
  id        String @id @default(cuid())
  creatorId String
  title     String
  name      String? // Alias for title (for compatibility)
  slug      String  @unique

  destination     String
  destinationCode String? // Airport/city code
  coverImageUrl   String?
  description     String   @db.Text
  highlights      String[]

  // Trip details
  startDate DateTime
  endDate   DateTime
  duration  Int // Days

  // Group settings
  minMembers     Int @default(2)
  maxMembers     Int @default(20)
  currentMembers Int @default(1)

  // Pricing
  estimatedPricePerPerson String
  currency                String @default("USD")
  totalBookingValue       Float  @default(0)

  // Inclusions
  included String[]

  // Booking settings
  bookingDeadline    DateTime?
  cancellationPolicy String?

  // Visibility
  status     String  @default("draft") // draft, published, full, completed, cancelled
  isActive   Boolean @default(true) // Whether trip is currently active
  visibility String  @default("public") // public, private, unlisted

  // Tags and categories
  tags       String[]
  category   String?  @default("adventure")
  difficulty String?  @default("moderate")

  // Promotions & Features (for homepage/marketing)
  featured Boolean @default(false) // Featured trips (highlighted on homepage)
  trending Boolean @default(false) // Trending trips (popular/high demand)

  // Analytics
  views        Int @default(0)
  applications Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  creator User          @relation("TripCreator", fields: [creatorId], references: [id], onDelete: Cascade)
  members GroupMember[]

  @@index([creatorId])
  @@index([slug])
  @@index([status, visibility])
  @@index([startDate])
  @@index([destination])
  @@index([featured, trending]) // Index for homepage queries
  @@map("trip_groups")
}

// TripMatch Group Members
model GroupMember {
  id          String @id @default(cuid())
  tripGroupId String
  userId      String
  role        String @default("member") // creator, member

  // Status
  status      String    @default("pending") // pending, confirmed, waitlist, cancelled
  joinedAt    DateTime  @default(now())
  confirmedAt DateTime?

  // Payment
  paymentStatus   String    @default("pending") // pending, completed, failed, refunded
  paymentIntentId String?
  amountPaid      Float?
  paidAt          DateTime?

  // Customization preferences
  customizations Json?

  tripGroup TripGroup @relation(fields: [tripGroupId], references: [id], onDelete: Cascade)
  user      User      @relation("GroupMemberships", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tripGroupId, userId])
  @@index([tripGroupId, status])
  @@index([userId])
  @@index([status])
  @@map("group_members")
}

// ==========================================
// TripMatch Social Network Features
// ==========================================

// TripMatch User Profiles (Extended social profiles)
model TripMatchUserProfile {
  id     String @id @default(cuid())
  userId String @unique

  // Profile Info
  displayName  String?
  bio          String?   @db.Text
  avatarUrl    String?
  coverImageUrl String?

  // Travel Preferences
  travelStyle       String[] // adventurer, luxury, budget, cultural, party, wellness
  interests         String[] // hiking, photography, food, nightlife, etc.
  languagesSpoken   String[]
  ageRange          String? // 18-24, 25-34, 35-44, 45-54, 55+
  gender            String? // male, female, non-binary, prefer-not-to-say

  // Location
  locationCity    String?
  locationCountry String?

  // Verification & Trust
  emailVerified      Boolean @default(false)
  phoneVerified      Boolean @default(false)
  idVerified         Boolean @default(false)
  safetyScore        Int     @default(0) // 0-100
  verificationLevel  Int     @default(0) // 0 = none, 1 = email, 2 = phone, 3 = ID

  // Social Stats
  tripsCreated       Int @default(0)
  tripsJoined        Int @default(0)
  tripsCompleted     Int @default(0)
  totalCompanionsMet Int @default(0)

  // Ratings
  avgRating    Float @default(0) // 0-5
  totalReviews Int   @default(0)

  // Matching Algorithm Data
  personalityVector Float[] // ML vector for matching

  // Settings
  settings Json? // Notification prefs, privacy settings, etc.

  // Relations
  user               User              @relation("TripMatchProfile", fields: [userId], references: [id], onDelete: Cascade)
  posts              TripPost[]
  postReactions      PostReaction[]
  postComments       PostComment[]
  messages           TripMessage[]
  reviewsGiven       TripReview[]      @relation("ReviewsGiven")
  reviewsReceived    TripReview[]      @relation("ReviewsReceived")
  connectionsFrom    UserConnection[]  @relation("ConnectionFrom")
  connectionsTo      UserConnection[]  @relation("ConnectionTo")
  matchesFrom        TravelerMatch[]   @relation("MatchFrom")
  matchesTo          TravelerMatch[]   @relation("MatchTo")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([locationCountry])
  @@index([verificationLevel])
  @@map("tripmatch_user_profiles")
}

// Trip Posts (Photos, updates, memories)
model TripPost {
  id     String @id @default(cuid())
  tripId String
  userId String

  // Content
  content   String? @db.Text
  mediaUrls String[] // Array of image/video URLs
  mediaType String?  // photo, video, mixed

  // Location
  location    String?
  locationLat Float?
  locationLng Float?

  // Engagement
  reactionsCount Int @default(0)
  commentsCount  Int @default(0)

  // Visibility
  visibility String @default("group") // group, public
  postType   String @default("update") // update, photo, memory, announcement

  // Relations
  profile   TripMatchUserProfile @relation(fields: [userId], references: [userId], onDelete: Cascade)
  reactions PostReaction[]
  comments  PostComment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tripId, createdAt])
  @@index([userId])
  @@index([visibility])
  @@map("trip_posts")
}

// Post Reactions (Like, Love, Wow, Haha, Fire)
model PostReaction {
  id     String @id @default(cuid())
  postId String
  userId String

  reactionType String // like, love, wow, haha, fire

  // Relations
  post    TripPost             @relation(fields: [postId], references: [id], onDelete: Cascade)
  profile TripMatchUserProfile @relation(fields: [userId], references: [userId], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([postId, userId]) // User can only react once per post
  @@index([postId])
  @@index([userId])
  @@map("post_reactions")
}

// Post Comments
model PostComment {
  id     String @id @default(cuid())
  postId String
  userId String

  content String @db.Text

  // Relations
  post    TripPost             @relation(fields: [postId], references: [id], onDelete: Cascade)
  profile TripMatchUserProfile @relation(fields: [userId], references: [userId], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([postId, createdAt])
  @@index([userId])
  @@map("post_comments")
}

// Trip Messages (Group Chat)
model TripMessage {
  id     String @id @default(cuid())
  tripId String
  userId String

  message     String  @db.Text
  messageType String  @default("text") // text, image, system
  attachments String[] // Array of attachment URLs

  // System Messages
  isSystemMessage Boolean @default(false)
  systemEvent     String? // member_joined, member_left, trip_updated, etc.

  // Read Receipts
  readBy String[] // Array of userIds who have read this message

  // Relations
  profile TripMatchUserProfile @relation(fields: [userId], references: [userId], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([tripId, createdAt])
  @@index([userId])
  @@map("trip_messages")
}

// Trip Reviews (Post-trip ratings)
model TripReview {
  id             String @id @default(cuid())
  tripId         String
  reviewerId     String // User giving the review
  reviewedUserId String // User being reviewed

  // Ratings
  overallRating        Int // 1-5
  communicationRating  Int? // 1-5
  reliabilityRating    Int? // 1-5
  friendlinessRating   Int? // 1-5

  // Review Content
  reviewText String? @db.Text
  isPublic   Boolean @default(true)

  // Relations
  reviewer       TripMatchUserProfile @relation("ReviewsGiven", fields: [reviewerId], references: [userId], onDelete: Cascade)
  reviewedUser   TripMatchUserProfile @relation("ReviewsReceived", fields: [reviewedUserId], references: [userId], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tripId, reviewerId, reviewedUserId]) // One review per user per trip
  @@index([tripId])
  @@index([reviewerId])
  @@index([reviewedUserId])
  @@map("trip_reviews")
}

// User Connections (Follow/Friend system)
model UserConnection {
  id         String @id @default(cuid())
  fromUserId String // User who initiated connection
  toUserId   String // User being connected to

  status String @default("pending") // pending, accepted, declined, blocked

  // Relations
  fromUser TripMatchUserProfile @relation("ConnectionFrom", fields: [fromUserId], references: [userId], onDelete: Cascade)
  toUser   TripMatchUserProfile @relation("ConnectionTo", fields: [toUserId], references: [userId], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([fromUserId, toUserId])
  @@index([fromUserId, status])
  @@index([toUserId, status])
  @@map("user_connections")
}

// Traveler Matching (Find compatible travel buddies)
model TravelerMatch {
  id         String @id @default(cuid())
  fromUserId String // User seeing the match
  toUserId   String // Suggested match

  // Match Score
  matchScore       Float   @default(0) // 0-100 compatibility score
  matchReasons     String[] // Common interests, similar travel style, etc.

  // User Action
  action           String? // liked, passed, blocked
  actionTaken      Boolean @default(false)

  // Match Data (snapshot at time of match)
  matchMetadata    Json? // Stores why they matched

  // Relations
  fromUser TripMatchUserProfile @relation("MatchFrom", fields: [fromUserId], references: [userId], onDelete: Cascade)
  toUser   TripMatchUserProfile @relation("MatchTo", fields: [toUserId], references: [userId], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([fromUserId, toUserId])
  @@index([fromUserId, actionTaken])
  @@index([toUserId])
  @@index([matchScore])
  @@map("traveler_matches")
}

// ==========================================
// Phase 8: Analytics & Business Intelligence
// ==========================================

// Analytics Events - Raw event tracking
model AnalyticsEvent {
  id        String  @id @default(cuid())
  userId    String?
  sessionId String
  eventType String // page_view, search, click, booking, conversion, etc.
  eventData Json // Flexible storage for event-specific data

  // Context
  url       String?
  referrer  String?
  userAgent String?
  ipAddress String?

  timestamp DateTime @default(now())

  @@index([eventType, timestamp])
  @@index([userId, timestamp])
  @@index([sessionId, timestamp])
  @@index([timestamp]) // For time-range queries
  @@map("analytics_events")
}

// Aggregated Metrics - Pre-calculated for dashboard performance
model MetricSnapshot {
  id          String   @id @default(cuid())
  metricName  String // dau, searches, conversions, revenue, etc.
  value       Float
  dimensions  Json // {route: "NYC-LAX", date: "2025-01-01", segment: "mobile"}
  timestamp   DateTime @default(now())
  granularity String // hourly, daily, weekly, monthly

  @@unique([metricName, granularity, timestamp])
  @@index([metricName, timestamp])
  @@index([timestamp, granularity])
  @@map("metric_snapshots")
}

// ML Price Predictions
model PricePrediction {
  id             String  @id @default(cuid())
  origin         String
  destination    String
  departDate     String
  returnDate     String?
  predictedPrice Float
  confidence     Float // 0.0 to 1.0
  priceRange     Json // {min: 450, max: 650}
  modelVersion   String
  features       Json // Feature values used for prediction

  // Recommendation
  recommendation  String? // "book_now", "wait", "flexible_dates"
  savingsEstimate Float?

  createdAt DateTime @default(now())
  expiresAt DateTime // Predictions valid for limited time

  @@index([origin, destination, departDate])
  @@index([createdAt])
  @@map("price_predictions")
}

// ML Model Metadata
model MLModel {
  id        String @id @default(cuid())
  name      String @unique
  version   String
  modelType String // regression, classification, etc.
  accuracy  Float? // Model performance metrics
  metrics   Json // {rmse: 45.2, mae: 32.1, r2: 0.85}

  // Training info
  trainedAt    DateTime
  trainingData Json // Summary of training data
  features     String[] // Feature names used

  // Deployment
  active     Boolean   @default(false)
  deployedAt DateTime?

  createdAt DateTime @default(now())

  @@index([name, version])
  @@index([active])
  @@map("ml_models")
}

// Feature Flags & A/B Testing
model FeatureFlag {
  id                String  @id @default(cuid())
  key               String  @unique
  name              String
  description       String?
  enabled           Boolean @default(false)
  rolloutPercentage Int     @default(0) // 0-100
  targetSegments    Json? // User segments to target
  variants          Json // [{id: "control", weight: 50}, {id: "variant_a", weight: 50}]

  // Experiment tracking
  isExperiment      Boolean @default(false)
  experimentStatus  String? // draft, running, completed, archived
  successMetric     String? // Metric to optimize
  minimumSampleSize Int?

  // Results
  experimentResults Json?
  winningVariant    String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  startedAt   DateTime?
  completedAt DateTime?

  participations ExperimentParticipation[]

  @@index([key])
  @@index([enabled])
  @@index([isExperiment, experimentStatus])
  @@map("feature_flags")
}

// Experiment Participation Tracking
model ExperimentParticipation {
  id         String   @id @default(cuid())
  flagId     String
  userId     String?
  sessionId  String
  variant    String
  assignedAt DateTime @default(now())

  // Conversion tracking
  converted       Boolean   @default(false)
  convertedAt     DateTime?
  conversionValue Float?

  flag FeatureFlag @relation(fields: [flagId], references: [id], onDelete: Cascade)

  @@unique([flagId, userId])
  @@unique([flagId, sessionId])
  @@index([flagId, variant])
  @@index([flagId, converted])
  @@map("experiment_participations")
}

// Performance Metrics (Web Vitals)
model PerformanceMetric {
  id         String @id @default(cuid())
  metricName String // LCP, FID, CLS, FCP, TTI, TTFB
  value      Float
  rating     String // good, needs-improvement, poor

  // Context
  url       String
  userId    String?
  sessionId String

  // Environment
  deviceType     String? // mobile, tablet, desktop
  browser        String?
  browserVersion String?
  os             String?
  connectionType String? // 4g, 3g, wifi

  timestamp DateTime @default(now())

  @@index([metricName, timestamp])
  @@index([url, metricName])
  @@index([rating, metricName])
  @@index([timestamp])
  @@map("performance_metrics")
}

// Error Tracking
model ErrorLog {
  id        String  @id @default(cuid())
  message   String  @db.Text
  stack     String? @db.Text
  errorType String? // TypeError, ReferenceError, etc.

  // Context
  url       String
  userId    String?
  sessionId String

  // Environment
  userAgent String?
  browser   String?
  os        String?

  // Metadata
  severity   String // error, warning, info
  resolved   Boolean   @default(false)
  resolvedAt DateTime?
  resolvedBy String?
  notes      String?   @db.Text

  // Grouping (for similar errors)
  fingerprint String? // Hash of error for grouping
  count       Int     @default(1)

  timestamp DateTime @default(now())

  @@index([severity, resolved, timestamp])
  @@index([fingerprint, timestamp])
  @@index([userId])
  @@index([timestamp])
  @@map("error_logs")
}

// Conversion Funnel Tracking
model ConversionFunnel {
  id        String  @id @default(cuid())
  sessionId String
  userId    String?

  // Funnel stages
  stage  String // search, results, details, booking, payment, confirmation
  action String // entered, completed, abandoned

  // Context
  metadata Json? // Route, price, filters, etc.
  duration Int? // Time spent in stage (ms)

  timestamp DateTime @default(now())

  @@index([sessionId, stage])
  @@index([stage, action, timestamp])
  @@index([timestamp])
  @@map("conversion_funnels")
}

// User Cohorts for Retention Analysis
model UserCohort {
  id          String   @id @default(cuid())
  userId      String
  cohortDate  DateTime // First signup/activity date
  cohortWeek  String // "2025-W01"
  cohortMonth String // "2025-01"

  // Activity tracking
  lastActiveAt DateTime

  // Retention flags
  day1Retained  Boolean @default(false)
  day7Retained  Boolean @default(false)
  day30Retained Boolean @default(false)

  // Engagement
  totalSessions Int   @default(0)
  totalSearches Int   @default(0)
  totalBookings Int   @default(0)
  lifetimeValue Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId])
  @@index([cohortDate])
  @@index([cohortWeek])
  @@index([cohortMonth])
  @@map("user_cohorts")
}

// ==========================================
// Phase 9: Admin Dashboard & CMS
// ==========================================

// Admin User Roles
model AdminUser {
  id     String @id @default(cuid())
  userId String @unique

  role        String // 'super_admin', 'admin', 'moderator'
  permissions Json? // Custom permissions override

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([role])
  @@map("admin_users")
}

// Audit Trail for Admin Actions
model AuditLog {
  id        String @id @default(cuid())
  userId    String
  userEmail String
  userRole  String

  action     String // 'create', 'update', 'delete', 'view'
  resource   String // 'user', 'deal', 'experiment', etc.
  resourceId String
  changes    Json?

  ipAddress String?
  userAgent String?
  requestId String?

  success      Boolean @default(true)
  errorMessage String?

  timestamp DateTime @default(now())

  @@index([userId, timestamp])
  @@index([resource, resourceId])
  @@index([timestamp])
  @@index([action, resource])
  @@map("audit_logs")
}

// Travel Deals Content
model Deal {
  id   String @id @default(cuid())
  slug String @unique

  title       String
  description String @db.Text

  destination Json // {city, country, airportCode}
  origin      String

  originalPrice   Float
  discountedPrice Float
  currency        String @default("USD")

  flightDetails Json // {airline, flightNumber, duration, stops, departDate, returnDate, etc}

  dealScore Int       @default(50)
  featured  Boolean   @default(false)
  active    Boolean   @default(true)
  expiresAt DateTime?

  category String   @default("featured") // flash_sale, last_minute, featured, seasonal
  tags     String[]

  images       Json // {thumbnail, hero, gallery}
  restrictions String[]

  seo Json // {metaTitle, metaDescription, keywords}

  // Analytics
  views       Int @default(0)
  clicks      Int @default(0)
  conversions Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String

  @@index([slug])
  @@index([active, featured])
  @@index([expiresAt])
  @@index([category])
  @@map("deals")
}

// Destinations Content
model Destination {
  id          String @id @default(cuid())
  slug        String @unique
  airportCode String @unique

  city    String
  country String
  region  String

  description      String   @db.Text
  shortDescription String
  highlights       String[]

  travelInfo   Json // {bestTimeToVisit, climate, activities, avgTemp, etc}
  priceRange   String // 'budget', 'moderate', 'luxury'
  avgPrice     Float?
  travelStyles String[] // beach, adventure, culture, food, romantic, etc

  images Json // {hero, gallery, video}

  seo Json // {metaTitle, metaDescription, keywords}

  published Boolean @default(false)
  featured  Boolean @default(false)
  trending  Boolean @default(false)

  // Analytics
  views    Int @default(0)
  searches Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([airportCode])
  @@index([published, featured])
  @@index([trending])
  @@map("destinations")
}

// Email Templates
model EmailTemplate {
  id   String @id @default(cuid())
  name String @unique
  key  String @unique // Internal key for referencing

  subject   String
  preheader String?
  body      String  @db.Text
  variables Json // [{name, type, default}]

  layout      String  @default("default") // default, marketing, transactional
  brandColor  String  @default("#3b82f6")
  headerImage String?
  footerText  String  @default("© 2025 Fly2Any. All rights reserved.")

  active Boolean @default(true)

  // Testing
  lastTested      DateTime?
  testRecipients  String[]
  testsSent       Int       @default(0)
  lastTestResults Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
  @@index([active])
  @@map("email_templates")
}

// Email Campaigns for Marketing
model EmailCampaign {
  id   String @id @default(cuid())
  name String // "Winter Sale 2024", "New Year Flash"

  // Campaign Type
  type   String @default("promotional") // promotional, newsletter, announcement, drip, transactional
  status String @default("draft") // draft, scheduled, sending, sent, paused, cancelled

  // Content
  subject   String
  preheader String?
  body      String  @db.Text // HTML content
  plainText String? @db.Text // Plain text fallback

  // Template reference (optional - can use predefined template)
  templateId String?

  // Targeting
  targetAudience String   @default("all") // all, active, new, custom
  customFilter   Json? // Custom filter criteria
  excludeList    String[] // Emails to exclude

  // Scheduling
  scheduledAt DateTime?
  startedAt   DateTime?
  completedAt DateTime?

  // Stats
  totalRecipients Int @default(0)
  sent            Int @default(0)
  delivered       Int @default(0)
  opened          Int @default(0)
  clicked         Int @default(0)
  bounced         Int @default(0)
  unsubscribed    Int @default(0)
  complained      Int @default(0)

  // Metadata
  createdBy String?
  tags      String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([type])
  @@index([scheduledAt])
  @@map("email_campaigns")
}

// Individual Email Sends within a Campaign
model EmailCampaignSend {
  id         String @id @default(cuid())
  campaignId String
  email      String

  // Status tracking
  status     String @default("pending") // pending, sent, delivered, opened, clicked, bounced, complained

  // Mailgun tracking
  messageId  String?

  // Timestamps
  sentAt      DateTime?
  deliveredAt DateTime?
  openedAt    DateTime?
  clickedAt   DateTime?
  bouncedAt   DateTime?

  // Metadata
  errorMessage String?
  metadata     Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([campaignId, email])
  @@index([campaignId])
  @@index([email])
  @@index([status])
  @@map("email_campaign_sends")
}

// System Health Monitoring
model HealthCheck {
  id String @id @default(cuid())

  service String // 'database', 'api', 'external:duffel', 'external:amadeus', etc
  status  String // 'healthy', 'degraded', 'down'

  responseTime Float?
  errorMessage String?
  metadata     Json?

  timestamp DateTime @default(now())

  @@index([service, timestamp])
  @@index([status, timestamp])
  @@map("health_checks")
}

// Search Autocomplete Cache
model SearchSuggestion {
  id String @id @default(cuid())

  query      String  @unique
  type       String // 'airport', 'city', 'country'
  code       String? // Airport code
  name       String
  country    String?
  popularity Int     @default(0)

  metadata Json? // Additional data (coordinates, timezone, etc)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([query])
  @@index([type, popularity])
  @@map("search_suggestions")
}

// ==========================================
// Hotel Booking System
// ==========================================

model HotelBooking {
  id                 String  @id @default(cuid())
  confirmationNumber String  @unique
  userId             String? // Nullable for guest bookings

  // Hotel Details
  hotelId      String
  hotelName    String
  hotelAddress String?
  hotelCity    String?
  hotelCountry String?
  hotelPhone   String?
  hotelEmail   String?
  hotelImages  Json?

  // Room Details
  roomId          String
  roomName        String
  roomDescription String?  @db.Text
  bedType         String?
  maxGuests       Int      @default(2)
  roomAmenities   String[]

  // Booking Dates
  checkInDate  DateTime
  checkOutDate DateTime
  nights       Int

  // Pricing
  pricePerNight Decimal @db.Decimal(10, 2)
  subtotal      Decimal @db.Decimal(10, 2)
  taxesAndFees  Decimal @db.Decimal(10, 2)
  totalPrice    Decimal @db.Decimal(10, 2)
  currency      String  @default("USD")

  // Guest Information (Primary Contact)
  guestTitle       String?
  guestFirstName   String
  guestLastName    String
  guestEmail       String
  guestPhone       String
  guestDateOfBirth DateTime?

  // Additional Guests (Stored as JSON)
  additionalGuests Json? // Array of guest objects

  // Special Requests
  specialRequests String? @db.Text

  // Payment Information
  paymentStatus   String    @default("pending") // pending, completed, failed, refunded
  paymentIntentId String?   @unique // Stripe payment intent ID
  paymentMethodId String? // Stripe payment method ID
  paymentProvider String    @default("stripe")
  paidAt          DateTime?
  refundedAt      DateTime?
  refundAmount    Decimal?  @db.Decimal(10, 2)
  refundReason    String?

  // Booking Status
  status String @default("pending") // pending, confirmed, cancelled, completed, no_show

  // Cancellation
  cancellationPolicy String? // free, partial, non_refundable
  cancellable        Boolean   @default(true)
  cancelledAt        DateTime?
  cancellationReason String?

  // Meal Plan
  mealPlan         String? // room_only, breakfast, half_board, full_board, all_inclusive
  mealPlanIncluded Boolean @default(false)

  // Provider Data
  provider          String  @default("duffel") // duffel, mock, etc.
  providerBookingId String? // ID from Duffel or other provider
  providerData      Json? // Raw booking data from provider

  // Confirmation & Notifications
  confirmationEmailSent Boolean   @default(false)
  confirmationSentAt    DateTime?
  reminderEmailSent     Boolean   @default(false)
  reminderSentAt        DateTime?

  // Metadata
  source     String? // web, mobile, api
  deviceType String? // desktop, mobile, tablet
  userAgent  String?
  ipAddress  String?
  notes      String? @db.Text

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Reviews
  reviews HotelReview[]

  @@index([userId])
  @@index([guestEmail])
  @@index([confirmationNumber])
  @@index([status])
  @@index([checkInDate])
  @@index([checkOutDate])
  @@index([paymentStatus])
  @@index([createdAt])
  @@map("hotel_bookings")
}

model HotelReview {
  id        String  @id @default(cuid())
  bookingId String
  userId    String?
  hotelId   String
  hotelName String

  // Overall Rating
  overallRating Int // 1-10

  // Breakdown Ratings
  cleanliness   Int? // 1-10
  comfort       Int? // 1-10
  location      Int? // 1-10
  facilities    Int? // 1-10
  staff         Int? // 1-10
  valueForMoney Int? // 1-10

  // Review Content
  title  String
  review String   @db.Text
  photos String[] // URLs to uploaded photos

  // Trip Details
  travelType String? // business, leisure, family, couple, solo
  stayDate   DateTime
  roomType   String?

  // Reviewer Info
  reviewerName  String
  reviewerEmail String?
  verified      Boolean @default(false) // Verified stay

  // Moderation
  status      String    @default("pending") // pending, approved, rejected, flagged
  moderatedAt DateTime?
  moderatedBy String?
  helpful     Int       @default(0) // Helpful votes count

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  booking HotelBooking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([hotelId, status])
  @@index([userId])
  @@index([bookingId])
  @@index([status])
  @@index([createdAt])
  @@map("hotel_reviews")
}

model HotelPriceAlert {
  id     String @id @default(cuid())
  userId String

  // Hotel Details
  hotelId   String
  hotelName String
  location  String

  // Dates
  checkInDate  DateTime
  checkOutDate DateTime
  nights       Int

  // Price Tracking
  currentPrice Float
  targetPrice  Float
  currency     String @default("USD")

  // Room Preferences
  roomType String?
  guests   Int     @default(2)

  // Alert Status
  active      Boolean   @default(true)
  triggered   Boolean   @default(false)
  lastChecked DateTime  @default(now())
  triggeredAt DateTime?

  // Notification
  emailNotification Boolean   @default(true)
  lastNotifiedAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, active])
  @@index([hotelId, active])
  @@index([active, lastChecked])
  @@map("hotel_price_alerts")
}

// ==========================================
// AFFILIATE PROGRAM SYSTEM
// ==========================================

// Affiliate Partner Model (ENHANCED FOR CREATORS/INFLUENCERS)
model Affiliate {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation("UserAffiliate", fields: [userId], references: [id], onDelete: Cascade)

  // Business Information
  businessName String?
  website      String?
  taxId        String? // For 1099 reporting (US) or tax compliance
  description  String? @db.Text

  // Tier System (Based on monthly completed trips)
  tier   String @default("starter") // starter, bronze, silver, gold, platinum
  status String @default("pending") // pending, active, suspended, banned

  // ============================================
  // NEW: CATEGORY SYSTEM
  // ============================================
  category String @default("standard")
  // Options: 'standard', 'creator', 'influencer', 'partner', 'enterprise'

  // ============================================
  // NEW: CREATOR PROFILE
  // ============================================
  creatorProfile Json?
  /**
   * Structure:
   * {
   * type: 'youtuber' | 'blogger' | 'influencer' | 'tiktoker' | 'podcaster' | 'deal_hunter',
   * primaryPlatform: 'youtube' | 'instagram' | 'tiktok' | 'blog' | 'twitter' | 'podcast',
   * platformHandle: '@username',
   * verifiedChannelUrl: 'https://youtube.com/@channel',
   * audienceSize: 100000,
   * engagementRate: 4.5,
   * demographics: {
   * primaryCountry: 'US',
   * ageRange: '25-34',
   * genderSplit: { male: 45, female: 55 }
   * },
   * contentNiche: ['travel', 'budget', 'family'],
   * mediaKitUrl: 'https://...',
   * rateCard: {
   * instagramPost: 5000,
   * instagramStory: 2000,
   * youtubeVideo: 10000,
   * tiktokVideo: 3000
   * }
   * }
   */

  // Channel verification
  channelVerified   Boolean   @default(false)
  channelVerifiedAt DateTime?
  channelVerifiedBy String? // Admin user ID

  // ============================================
  // NEW: CUSTOM COMMISSION STRUCTURE
  // ============================================
  customCommissionEnabled Boolean @default(false)

  // Per-product commission rates (overrides tier-based rates)
  customFlightCommission   Float? // e.g., 0.35 = 35%
  customHotelCommission    Float?
  customPackageCommission  Float?
  customCarCommission      Float?
  customActivityCommission Float?

  // ============================================
  // NEW: BONUS STRUCTURE
  // ============================================

  // Volume Bonus (extra % after X bookings per month)
  volumeBonusEnabled   Boolean @default(false)
  volumeBonusThreshold Int? // e.g., 20 bookings/month
  volumeBonusRate      Float? // e.g., 0.05 = +5% extra

  // Performance Bonus (extra % if conversion rate high)
  performanceBonusEnabled Boolean @default(false)
  performanceBonusTarget  Float? // e.g., 0.03 = 3% conversion rate
  performanceBonusRate    Float? // e.g., 0.05 = +5% extra

  // Exclusivity Bonus (extra % for not promoting competitors)
  exclusivityBonusEnabled Boolean   @default(false)
  exclusivityBonusRate    Float? // e.g., 0.10 = +10% extra
  exclusivityAgreedAt     DateTime?
  exclusivityEndsAt       DateTime?

  // ============================================
  // NEW: PREMIUM FEATURES
  // ============================================

  // Custom landing pages
  hasCustomLandingPage  Boolean @default(false)
  customLandingPageSlug String? @unique // e.g., 'fly2any.com/deals/travelwithdan'

  // Branded short links
  hasBrandedLinks Boolean @default(false)
  brandedDomain   String? // e.g., 'deals.travelwithdan.com'

  // API access
  hasApiAccess      Boolean   @default(false)
  apiKey            String?   @unique
  apiKeyLastUsed    DateTime?
  apiCallsThisMonth Int       @default(0)
  apiCallsLimit     Int       @default(10000) // per month

  // Dedicated account manager
  hasDedicatedAM      Boolean @default(false)
  accountManagerId    String? // Admin user ID
  accountManagerEmail String?

  // Priority support
  hasPrioritySupport Boolean @default(false)

  // Early deal access
  hasEarlyDealAccess Boolean @default(false)

  // Co-marketing opportunities
  coMarketingEnabled Boolean @default(false)
  featuredOnWebsite  Boolean @default(false)

  // ============================================
  // NEW: TRUST LEVEL & HOLD PERIOD
  // ============================================

  // Trust level affects hold period duration
  trustLevel String @default("new")
  // Options: 'new', 'trusted', 'verified', 'platinum'

  // Successful bookings (completed, not refunded)
  successfulBookingsCount Int @default(0)

  // Failed bookings (cancelled/refunded after payout)
  failedBookingsCount Int @default(0)

  // Trust score (0-100, affects hold period)
  trustScore Float @default(50)

  // Custom hold period override (days after trip completion)
  customHoldPeriod Int? // null = use default based on category + trust level

  // ============================================
  // NEW: CONTENT TRACKING
  // ============================================

  // Content performance tracking
  topPerformingContent Json?
  /**
   * Structure:
   * [
   * {
   * contentTitle: "Top 10 Cheapest Flights to Europe",
   * contentUrl: "https://youtube.com/watch?v=...",
   * clicks: 2547,
   * conversions: 52,
   * revenue: 1820,
   * conversionRate: 2.04
   * }
   * ]
   */

  // Platform-specific metrics
  platformMetrics Json?
  /**
   * Structure:
   * {
   * youtube: {
   * subscribers: 150000,
   * avgViews: 50000,
   * engagementRate: 4.2
   * },
   * instagram: {
   * followers: 80000,
   * avgLikes: 3200,
   * engagementRate: 4.0
   * }
   * }
   */

  // Last metrics update
  metricsLastUpdated DateTime?

  // Performance Metrics (Completed Trips Only)
  totalClicks      Int @default(0)
  totalReferrals   Int @default(0)
  completedTrips   Int @default(0) // Only completed & paid trips
  canceledBookings Int @default(0)
  refundedBookings Int @default(0)

  // Revenue Tracking
  totalCustomerSpend     Float @default(0) // Total amount customers paid
  totalYourProfit        Float @default(0) // Your profit from all bookings
  totalCommissionsEarned Float @default(0) // Total earned by affiliate
  totalCommissionsPaid   Float @default(0) // Total actually paid out

  // Current Month Stats (resets monthly)
  monthlyCompletedTrips Int      @default(0)
  monthlyRevenue        Float    @default(0)
  monthlyCommissions    Float    @default(0)
  monthStatsLastReset   DateTime @default(now())

  // Balance Management
  currentBalance   Float @default(0) // Available for payout (can be negative)
  pendingBalance   Float @default(0) // In hold period or awaiting completion
  lifetimeEarnings Float @default(0)
  lifetimePaid     Float @default(0)

  // Payout Settings
  minPayoutThreshold Float   @default(50)
  payoutMethod       String  @default("paypal") // paypal, stripe, bank_transfer
  payoutEmail        String? // For PayPal
  payoutDetails      Json? // Encrypted bank details for wire transfer

  // Tracking Identifiers
  referralCode String @unique // Human-readable: "JOHN20"
  trackingId   String @unique // UUID for link tracking

  // Marketing Materials
  customLandingPage String?
  customBranding    Json? // Logo, colors, etc.

  // Communication Preferences
  emailNotifications Boolean @default(true)
  weeklyReports      Boolean @default(true)
  monthlyStatements  Boolean @default(true)

  // Admin Notes & Review
  adminNotes       String?   @db.Text
  reviewedBy       String?
  reviewedAt       DateTime?
  approvedAt       DateTime?
  suspendedAt      DateTime?
  suspensionReason String?
  bannedAt         DateTime?
  banReason        String?

  // Relationships
  referrals        AffiliateReferral[]
  commissions      Commission[]
  payouts          Payout[]
  flatFeeCampaigns FlatFeeCampaign[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tier, status])
  @@index([status])
  @@index([category])
  @@index([referralCode])
  @@index([trackingId])
  @@index([monthlyCompletedTrips])
  @@index([trustLevel])
  @@map("affiliates")
}

// Affiliate Referral Tracking Model
model AffiliateReferral {
  id          String    @id @default(cuid())
  affiliateId String
  affiliate   Affiliate @relation(fields: [affiliateId], references: [id], onDelete: Cascade)

  // Click Tracking
  clickId     String  @unique // Unique click identifier
  ipAddress   String
  userAgent   String  @db.Text
  referrerUrl String? @db.Text
  landingPage String  @db.Text

  // UTM Parameters (for campaign tracking)
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  utmTerm     String?
  utmContent  String?

  // Device & Location
  deviceType String? // mobile, tablet, desktop
  browser    String?
  os         String?
  country    String?
  city       String?

  // Conversion Tracking
  userId    String? // If user signed up
  bookingId String? // If booking was made

  // Cookie Attribution
  cookieSet    Boolean  @default(true)
  cookieExpiry DateTime // 30 days from click

  // Conversion Timeline
  clickedAt   DateTime  @default(now())
  signedUpAt  DateTime?
  bookedAt    DateTime?
  convertedAt DateTime?
  completedAt DateTime? // When referral was completed

  // Status Flow: click → signed_up → booked → completed → canceled
  status String @default("click") // click, signed_up, booked, completed, canceled, refunded

  // Relationships
  commission Commission?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([affiliateId, status])
  @@index([clickId])
  @@index([bookingId])
  @@index([cookieExpiry])
  @@index([clickedAt])
  @@map("affiliate_referrals")
}

// Commission Model (ENHANCED FOR TRIP LIFECYCLE)
model Commission {
  id          String    @id @default(cuid())
  affiliateId String
  affiliate   Affiliate @relation(fields: [affiliateId], references: [id], onDelete: Cascade)

  // Source References
  referralId String            @unique
  referral   AffiliateReferral @relation(fields: [referralId], references: [id])
  bookingId  String            @unique // Links to Booking model
  userId     String // Customer who booked

  // Product Information
  bookingType    String // flight, hotel, car, package, tour, activity
  productDetails Json // Store product name, destination, etc.

  // Revenue Breakdown (Critical for hybrid model)
  revenueModel      String // "commission" or "markup"
  customerTotalPaid Float // What customer paid
  supplierCost      Float // What you paid to supplier
  yourGrossProfit   Float // customerTotalPaid - supplierCost

  // Commission Calculation
  affiliateTierAtBooking String // Tier when booking was made
  commissionRate         Float // 0.15, 0.20, 0.25, 0.30, 0.35 (based on tier)
  commissionAmount       Float // yourGrossProfit * commissionRate

  // Minimum/Maximum Caps Applied
  minPayoutApplied Boolean @default(false)
  maxPayoutApplied Boolean @default(false)
  cappedAmount     Float? // If capped, what was the original amount

  // ============================================
  // ENHANCED: TRIP LIFECYCLE DATES
  // ============================================
  bookingDate   DateTime // When customer booked
  tripStartDate DateTime // When trip begins (departure/check-in)
  tripEndDate   DateTime // When trip ends (return/check-out)

  tripStartedAt   DateTime? // Actual start (for tracking)
  tripCompletedAt DateTime? // Actual completion

  // ============================================
  // ENHANCED: LIFECYCLE STATUS
  // ============================================
  status String @default("pending")
  /**
   * Enhanced Status Flow:
   * - 'pending': Booking created, waiting for trip
   * - 'trip_in_progress': Trip started
   * - 'trip_completed': Trip finished successfully
   * - 'in_hold_period': Waiting for hold period to expire
   * - 'available': Ready for payout
   * - 'payout_requested': Included in payout request
   * - 'payout_approved': Admin approved payout
   * - 'paid': Money sent
   * - 'cancelled': Booking cancelled before trip
   * - 'reversed': Refunded after payout (clawback)
   */

  statusHistory Json? // Array of {status, timestamp, note}

  // Hold Period (variable based on category + trust level)
  holdPeriodDays   Int       @default(30)
  holdPeriodEndsAt DateTime? // When commission becomes available
  releasedAt       DateTime? // When commission was released from hold period

  // ============================================
  // NEW: CANCELLATION/REFUND TRACKING
  // ============================================
  cancelledAt  DateTime?
  cancelReason String?   @db.Text

  refundedAt   DateTime?
  refundAmount Float?
  refundReason String?   @db.Text

  // Was this a fraud/chargeback?
  isFraud         Boolean   @default(false)
  fraudDetectedAt DateTime?
  fraudNotes      String?   @db.Text

  // ============================================
  // NEW: BONUS TRACKING
  // ============================================

  // Base commission
  baseCommissionRate   Float // e.g., 0.25 = 25%
  baseCommissionAmount Float

  // Bonuses applied
  volumeBonusApplied Boolean @default(false)
  volumeBonusAmount  Float   @default(0)

  performanceBonusApplied Boolean @default(false)
  performanceBonusAmount  Float   @default(0)

  exclusivityBonusApplied Boolean @default(false)
  exclusivityBonusAmount  Float   @default(0)

  // Total commission (base + all bonuses)
  totalCommissionAmount Float

  // ============================================
  // NEW: CONTENT ATTRIBUTION
  // ============================================

  // What content drove this booking?
  contentSource String? // "youtube", "instagram", "blog", "email"
  contentUrl    String? // URL to the video/post/article
  contentTitle  String? // "Top 10 Cheapest Flights to Europe"

  // UTM tracking
  utmCampaign String?
  utmSource   String?
  utmMedium   String?
  utmContent  String?

  // Payment Tracking
  approvedAt DateTime?
  paidAt     DateTime?
  payoutId   String?
  payout     Payout?   @relation(fields: [payoutId], references: [id])

  // Reversal/Refund Handling (deprecated in favor of new fields above)
  reversed       Boolean   @default(false)
  reversedAt     DateTime?
  reversalReason String? // "booking_canceled", "customer_refund", "chargeback", "fraud"
  reversalAmount Float? // Amount deducted from affiliate

  // Notes
  adminNotes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([affiliateId, status])
  @@index([bookingId])
  @@index([status])
  @@index([status, holdPeriodEndsAt])
  @@index([tripEndDate])
  @@index([holdPeriodEndsAt])
  @@index([approvedAt])
  @@map("commissions")
}

// Payout Model
model Payout {
  id          String    @id @default(cuid())
  affiliateId String
  affiliate   Affiliate @relation(fields: [affiliateId], references: [id], onDelete: Cascade)

  // Payout Details
  amount              Float
  commissionsIncluded Commission[]
  commissionCount     Int // How many commissions bundled

  // Period Covered
  periodStart DateTime
  periodEnd   DateTime

  // Payment Information
  method        String // paypal, stripe, bank_transfer
  paymentEmail  String? // For PayPal
  bankDetails   Json? // Encrypted for bank transfers
  transactionId String? // External payment processor reference

  // Processing
  status        String    @default("pending") // pending, processing, completed, failed, canceled
  processedAt   DateTime?
  completedAt   DateTime?
  failedAt      DateTime?
  failureReason String?   @db.Text

  // Fees (if applicable)
  processingFee Float  @default(0)
  netAmount     Float // amount - processingFee
  currency      String @default("USD")

  // Invoice/Receipt
  invoiceNumber String? @unique
  receiptUrl    String?

  // Admin
  processedBy String?
  adminNotes  String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([affiliateId, status])
  @@index([status])
  @@index([periodStart, periodEnd])
  @@index([processedAt])
  @@map("payouts")
}

// Affiliate Activity Log (for auditing)
model AffiliateActivityLog {
  id          String @id @default(cuid())
  affiliateId String

  activityType String // tier_upgrade, commission_earned, payout_processed, status_change, etc.
  description  String @db.Text
  metadata     Json? // Additional context

  performedBy String? // Admin user ID if manual action
  ipAddress   String?

  createdAt DateTime @default(now())

  @@index([affiliateId, createdAt])
  @@index([activityType])
  @@map("affiliate_activity_logs")
}

// ============================================
// FLAT FEE CAMPAIGNS (For Influencers)
// ============================================
model FlatFeeCampaign {
  id String @id @default(cuid())

  // Relationship
  affiliateId String
  affiliate   Affiliate @relation(fields: [affiliateId], references: [id], onDelete: Cascade)

  // Campaign Details
  campaignName String // "Bali Launch - Instagram Campaign"
  campaignType String // "sponsored_post", "video_integration", "story_series"

  // Platform & Content
  platform     String // "instagram", "youtube", "tiktok", "blog"
  contentType  String // "post", "story", "reel", "video", "article"
  deliverables String @db.Text // "1 Instagram feed post + 3 stories"

  // Pricing
  flatFeeAmount Float // $5,000
  currency      String @default("USD")

  // Plus commission on any bookings?
  includesCommission Boolean @default(true)
  commissionRate     Float? // e.g., 0.25 = 25%

  // Status tracking
  status String @default("draft")
  // Options: 'draft', 'proposed', 'negotiating', 'approved', 'in_progress', 'awaiting_review', 'completed', 'paid', 'cancelled'

  // Timeline
  proposedAt  DateTime?
  approvedAt  DateTime?
  approvedBy  String? // Admin user ID
  startDate   DateTime?
  dueDate     DateTime?
  completedAt DateTime?

  // Proof of work
  deliveryProof Json?
  /**
   * Structure:
   * [
   * {
   * platform: "instagram",
   * type: "post",
   * url: "https://instagram.com/p/...",
   * postedAt: "2025-01-15T10:30:00Z",
   * metrics: {
   * likes: 5420,
   * comments: 234,
   * saves: 891,
   * reach: 45000
   * }
   * }
   * ]
   */

  // Admin review
  reviewedAt  DateTime?
  reviewedBy  String? // Admin user ID
  reviewNotes String?   @db.Text

  // Payment
  paidAt        DateTime?
  paidBy        String? // Admin user ID
  paymentMethod String? // "paypal", "stripe", "bank_transfer"
  invoiceNumber String?   @unique

  // Tracking
  trackingUrl String? // Special tracking URL for this campaign
  clicks      Int     @default(0)
  conversions Int     @default(0)
  revenue     Float   @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([affiliateId, status])
  @@index([status])
  @@map("flat_fee_campaigns")
}

// ============================================
// HOLD PERIOD CONFIGURATION
// ============================================
model HoldPeriodConfig {
  id String @id @default(cuid())

  // Which category + trust level
  category   String // "standard", "creator", "influencer", "partner"
  trustLevel String // "new", "trusted", "verified", "platinum"

  // Hold period in days after trip completion
  holdPeriodDays Int

  // Requirements to reach this trust level
  minSuccessfulBookings Int? // e.g., 10 successful bookings to be "trusted"
  minTrustScore         Float? // e.g., 80/100

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([category, trustLevel])
  @@map("hold_period_configs")
}

// ============================================
// COMMISSION LIFECYCLE LOG (Audit Trail)
// ============================================
model CommissionLifecycleLog {
  id String @id @default(cuid())

  commissionId String

  // Status change
  fromStatus String
  toStatus   String

  // When & why
  changedAt DateTime @default(now())
  reason    String?  @db.Text
  changedBy String? // Admin user ID (if manual)

  // Automated or manual?
  automated Boolean @default(true)

  // Metadata
  metadata Json?

  @@index([commissionId])
  @@index([commissionId, changedAt])
  @@map("commission_lifecycle_logs")
}

// ==========================================
// TRAVEL AGENT PROGRAM
// Revolutionary B2B Platform for Travel Agents
// ==========================================

// Travel Agent Profile (Professional Agent Account)
model TravelAgent {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation("UserTravelAgent", fields: [userId], references: [id], onDelete: Cascade)

  // Business Information
  agencyName    String?
  businessName  String? // Alias for agencyName
  company       String? // Company name
  iataNumber    String? @unique // IATA accreditation number
  arcNumber     String? // ARC number (US)
  licenseNumber String? // Business license
  businessType  String? // sole_proprietor, llc, corporation, partnership

  // Branding & Customization
  logo           String? // Logo URL
  brandColor     String? // Primary brand color (hex)
  customDomain   String? @unique // e.g., youragency.fly2any.com or custom domain
  emailSignature String? @db.Text // Custom email signature

  // Tier System (Based on monthly volume)
  tier   AgentTier   @default(INDEPENDENT)
  status AgentStatus @default(PENDING)

  // Admin & Testing Flags
  isTestAccount Boolean @default(false) // True for admin-created test agents

  // Commission Settings
  defaultCommission   Float           @default(0.05) // 5% platform fee
  commissionModel     CommissionModel @default(PERCENTAGE)
  flightCommission    Float? // Custom flight markup %
  hotelCommission     Float? // Custom hotel markup %
  activityCommission  Float? // Custom activity markup %
  transferCommission  Float? // Custom transfer markup %
  insuranceCommission Float? // Custom insurance markup %
  carRentalCommission Float? // Custom car rental markup %

  // Business Contact Information
  firstName   String? // Agent's first name (from user)
  lastName    String? // Agent's last name (from user)
  email       String? // Agent's email (from user)
  phone       String? // Agent's phone (alias for phoneNumber)
  website     String?
  phoneNumber String?
  address     String? @db.Text
  city        String?
  state       String?
  country     String?
  zipCode     String?
  timezone    String?

  // Operating Hours (JSON: {monday: {open: "09:00", close: "17:00"}, ...})
  operatingHours Json?

  // Performance Metrics
  totalSales         Float    @default(0)
  totalCommissions   Float    @default(0)
  quotesSent         Int      @default(0)
  quotesAccepted     Int      @default(0)
  conversionRate     Float    @default(0)
  avgDealSize        Float    @default(0)
  clientSatisfaction Float? // 0-5 rating
  responseTime       Int? // Average response time in minutes
  bookingsThisMonth  Int      @default(0)
  revenueThisMonth   Float    @default(0)
  monthStatsResetAt  DateTime @default(now())

  // Premium Features (Based on tier)
  hasClientPortal        Boolean @default(false)
  hasTeamManagement      Boolean @default(false)
  hasAdvancedAnalytics   Boolean @default(false)
  hasWhiteLabel          Boolean @default(false)
  hasApiAccess           Boolean @default(false)
  hasPrioritySupport     Boolean @default(false)
  hasCustomBranding      Boolean @default(false)
  hasSmsNotifications    Boolean @default(false)
  hasWhatsappIntegration Boolean @default(false)

  // API Access (for Enterprise tier)
  apiKey          String?   @unique
  apiKeyCreatedAt DateTime?
  apiCallsLimit   Int       @default(1000)
  apiCallsUsed    Int       @default(0)

  // Limits (based on tier)
  maxClients         Int @default(50)
  maxActiveQuotes    Int @default(100)
  maxTeamMembers     Int @default(1)
  maxMonthlyBookings Int @default(999999)

  // Payout Settings
  minPayoutThreshold Float   @default(100) // Minimum $100 for payout
  payoutMethod       String  @default("stripe") // stripe, paypal, bank_transfer
  payoutSchedule     String  @default("monthly") // instant, weekly, monthly
  payoutEmail        String? // For PayPal
  stripeAccountId    String? @unique // Stripe Connect account ID
  bankDetails        Json? // Encrypted bank details

  // Balance Tracking
  currentBalance   Float @default(0) // Available for payout
  availableBalance Float @default(0) // Alias for currentBalance (for compatibility)
  pendingBalance   Float @default(0) // In hold or pending completion
  lifetimeEarnings Float @default(0)
  lifetimePaid     Float @default(0)

  // Notification Preferences
  emailNotifications   Boolean @default(true)
  quoteAcceptedEmail   Boolean @default(true)
  paymentReceivedEmail Boolean @default(true)
  clientMessageEmail   Boolean @default(true)
  weeklyReports        Boolean @default(true)
  monthlyStatements    Boolean @default(true)
  smsNotifications     Boolean @default(false)

  // Onboarding & Verification
  onboardingCompleted   Boolean   @default(false)
  onboardingStep        Int       @default(0)
  verified              Boolean   @default(false)
  verifiedAt            DateTime?
  verifiedBy            String? // Admin user ID
  verificationDocuments Json? // URLs to verification documents

  // Admin Notes & Management
  adminNotes       String?   @db.Text
  accountManager   String? // Admin user ID
  reviewedBy       String?
  reviewedAt       DateTime?
  approvedAt       DateTime?
  suspendedAt      DateTime?
  suspensionReason String?   @db.Text
  bannedAt         DateTime?
  banReason        String?   @db.Text

  // Relations
  clients      AgentClient[]
  quotes       AgentQuote[]
  bookings     AgentBooking[]
  team         AgentTeamMember[]        @relation("AgencyTeam")
  memberOf     AgentTeamMember[]        @relation("AgentMemberships")
  commissions  AgentCommission[]
  payouts      AgentPayout[]
  activityLogs AgentActivityLog[]
  templates    AgentItineraryTemplate[]
  suppliers    AgentSupplier[]          @relation("AgentSuppliers")
  products     AgentProduct[]           @relation("AgentProducts")

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  @@index([tier, status])
  @@index([status])
  @@index([userId])
  @@index([bookingsThisMonth])
  @@map("travel_agents")
}

enum AgentTier {
  INDEPENDENT // Solo agent - 5% platform fee
  PROFESSIONAL // $10K+/month - 3% platform fee
  AGENCY_PARTNER // $50K+/month - 2% platform fee
  WHITE_LABEL // $100K+/month - 1.5% platform fee + $499/month
}

enum AgentStatus {
  PENDING // Application pending
  ACTIVE // Approved and active
  SUSPENDED // Temporarily disabled
  INACTIVE // Closed account
  BANNED // Permanently banned
}

enum CommissionModel {
  PERCENTAGE // % markup on cost
  FLAT_FEE // Fixed fee per booking
  HYBRID // Percentage + flat fee
  CUSTOM // Custom per client
}

// Agent's Clients (CRM System)
model AgentClient {
  id      String      @id @default(cuid())
  agentId String
  agent   TravelAgent @relation(fields: [agentId], references: [id], onDelete: Cascade)
  userId  String?     @unique // If client has a user account
  user    User?       @relation("UserAgentClient", fields: [userId], references: [id])

  // Client Information
  firstName String
  lastName  String
  email     String
  phone     String?
  company   String? // For corporate clients

  // Personal Details
  dateOfBirth       DateTime?
  anniversary       DateTime? // For special offers
  preferredLanguage String?   @default("en")
  nationality       String? // ISO country code

  // Address
  address String? @db.Text
  city    String?
  state   String?
  country String?
  zipCode String?

  // Travel Profile
  cabinClass          String? // economy, premium, business, first
  preferredAirlines   String[] // ['AA', 'UA', 'DL']
  homeAirport         String? // JFK
  seatPreference      String? // window, aisle
  mealPreference      String? // vegetarian, vegan, kosher, halal, etc
  specialNeeds        String?  @db.Text // wheelchair, oxygen, etc
  dietaryRestrictions String[]

  // Loyalty Programs (JSON: {airline: {program: "AA Advantage", number: "12345"}})
  frequentFlyerPrograms Json?
  hotelLoyaltyPrograms  Json?
  carRentalPrograms     Json?

  // Travel Documents
  passportNumber      String?
  passportExpiry      DateTime?
  passportCountry     String? // Issuing country
  visas               Json? // Array of visa details
  tsaPrecheck         Boolean   @default(false)
  globalEntry         Boolean   @default(false)
  knownTravelerNumber String?
  redressNumber       String?

  // Preferences
  budgetRange          String? // budget, moderate, luxury, ultra_luxury
  tripTypes            String[] // beach, adventure, luxury, family, business, romance
  favoriteDestinations String[]
  travelStyle          String? // luxury, budget, adventure, relaxation, culture

  // Communication Preferences
  preferredChannel  String? // email, sms, whatsapp, phone
  bestTimeToContact String? // morning, afternoon, evening
  doNotDisturb      Boolean @default(false)

  // Segmentation & Tags
  segment  ClientSegment @default(STANDARD)
  tags     String[] // vip, honeymoon, repeat, corporate, etc
  vipLevel Int           @default(0) // 0-5
  priority String        @default("normal") // low, normal, high, urgent

  // Relationship Tracking
  source          String? // referral, website, social, advertisement, event
  referredBy      String? // Another client's ID
  lifetimeValue   Float     @default(0)
  totalBookings   Int       @default(0)
  totalSpent      Float     @default(0)
  avgBookingValue Float     @default(0)
  lastBookingDate DateTime?
  nextBookingDate DateTime? // Predicted or scheduled
  lastContactDate DateTime?

  // Client Status
  status          ClientStatus @default(ACTIVE)
  isVip           Boolean      @default(false)
  blacklisted     Boolean      @default(false)
  blacklistReason String?      @db.Text

  // Notes & History
  notes            String? @db.Text
  internalNotes    String? @db.Text // Not visible to client
  communicationLog Json? // Array of communication history

  // Relations
  quotes      AgentQuote[]
  bookings    AgentBooking[]
  clientNotes AgentClientNote[]
  documents   AgentClientDocument[]

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  @@unique([agentId, email])
  @@index([agentId])
  @@index([agentId, segment])
  @@index([email])
  @@index([status])
  @@map("agent_clients")
}

enum ClientSegment {
  STANDARD // Regular traveler
  VIP // High spender
  HONEYMOON // Honeymoon specialist
  FAMILY // Family traveler
  BUSINESS // Business traveler
  GROUP_ORGANIZER // Group trip organizer
  CORPORATE // Corporate account
  LUXURY // Luxury traveler
}

enum ClientStatus {
  ACTIVE // Active client
  INACTIVE // No recent activity
  ARCHIVED // Archived
  LOST // Lost to competitor
  DO_NOT_CONTACT // Requested no contact
}

// Agent Quote (Multi-Product Quote Builder)
model AgentQuote {
  id          String      @id @default(cuid())
  quoteNumber String      @unique // QT-2025-001234
  agentId     String
  agent       TravelAgent @relation(fields: [agentId], references: [id], onDelete: Cascade)
  clientId    String
  client      AgentClient @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Trip Overview
  tripName    String // "Paris Honeymoon", "Family Disney Vacation"
  destination String
  startDate   DateTime
  endDate     DateTime
  duration    Int // Days
  travelers   Int
  adults      Int      @default(1)
  children    Int      @default(0)
  infants     Int      @default(0)

  // Quote Components (Flexible JSON Storage)
  flights     Json[] // [{ from, to, airline, flight, date, time, class, price, ... }]
  hotels      Json[] // [{ name, location, checkIn, checkOut, nights, roomType, price, ... }]
  activities  Json[] // [{ name, description, date, duration, price, ... }]
  transfers   Json[] // [{ type, from, to, date, time, vehicle, price, ... }]
  carRentals  Json[] // [{ company, carType, pickUp, dropOff, days, price, ... }]
  insurance   Json? // { provider, plan, coverage, price, ... }
  customItems Json[] // [{ name, description, category, price, ... }]

  // Pricing Breakdown
  flightsCost     Float @default(0)
  hotelsCost      Float @default(0)
  activitiesCost  Float @default(0)
  transfersCost   Float @default(0)
  carRentalsCost  Float @default(0)
  insuranceCost   Float @default(0)
  customItemsCost Float @default(0)

  subtotal           Float
  agentMarkup        Float // Your commission/markup
  agentMarkupPercent Float? // Percentage if applicable
  taxes              Float  @default(0)
  fees               Float  @default(0)
  discount           Float  @default(0) // Discount applied
  total              Float

  currency String @default("USD")

  // Commission Display Settings
  showCommissionToClient Boolean @default(false)
  commissionLabel        String? // "Service Fee", "Planning Fee", "Consultation Fee"
  hideMarkupBreakdown    Boolean @default(true)

  // Quote Versions (for alternatives - Economy vs Business vs First)
  version       Int     @default(1)
  versionName   String? // "Economy Package", "Business Class Package", "First Class Luxury"
  parentQuoteId String? // If this is an alternative version
  isAlternative Boolean @default(false)

  // Quote Lifecycle
  status        QuoteStatus @default(DRAFT)
  expiresAt     DateTime
  sentAt        DateTime?
  viewedAt      DateTime?
  viewCount     Int         @default(0)
  lastViewedAt  DateTime?
  acceptedAt    DateTime?
  declinedAt    DateTime?
  declineReason String?     @db.Text

  // Client Interaction
  clientFeedback       String? @db.Text // Client's comments/requests
  modificationRequests String? @db.Text
  agentNotes           String? @db.Text // Internal notes
  notes                String? @db.Text // Alias for agentNotes (for compatibility)
  sharedWithClient     Boolean @default(false)

  // Itinerary Details
  itineraryTemplate  String? // Template ID or name
  itineraryContent   Json? // Day-by-day itinerary
  customNotes        String?  @db.Text // Custom notes for itinerary
  inclusions         String[] // What's included
  exclusions         String[] // What's not included
  importantInfo      String?  @db.Text
  termsAndConditions String?  @db.Text

  // Documents & Sharing
  pdfUrl         String? // Generated PDF URL
  shareableLink  String?   @unique // Public shareable link
  linkPassword   String? // Optional password protection
  linkExpiresAt  DateTime?
  emailSentCount Int       @default(0)
  smsSentCount   Int       @default(0)

  // Conversion Tracking
  convertedToBooking Boolean       @default(false)
  bookingId          String?       @unique
  booking            AgentBooking?
  convertedAt        DateTime?

  // Collaboration
  sharedWithTeam Boolean @default(false)
  assignedTo     String? // Team member ID

  // Payment Terms (if accepted)
  depositRequired     Boolean   @default(false)
  depositAmount       Float?
  depositDueDate      DateTime?
  finalPaymentDueDate DateTime?

  // Analytics
  timeToView    Int? // Minutes from sent to first view
  timeToAccept  Int? // Minutes from sent to acceptance
  timeToDecline Int? // Minutes from sent to decline

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  @@index([agentId, status])
  @@index([clientId, status])
  @@index([quoteNumber])
  @@index([status])
  @@index([expiresAt])
  @@index([createdAt])
  @@map("agent_quotes")
}

enum QuoteStatus {
  DRAFT // Agent is building
  SENT // Sent to client
  VIEWED // Client opened it
  MODIFIED // Client requested changes
  ACCEPTED // Client accepted
  EXPIRED // Past expiration date
  DECLINED // Client declined
  CONVERTED // Became a booking
  CANCELLED // Cancelled by agent
  ARCHIVED // Archived
}

// Agent Booking (Confirmed Trips)
model AgentBooking {
  id                 String      @id @default(cuid())
  confirmationNumber String      @unique // BK-2025-001234
  bookingNumber      String?     // Alias for confirmationNumber
  bookingReference   String?     // External reference
  agentId            String
  agent              TravelAgent @relation(fields: [agentId], references: [id], onDelete: Cascade)
  clientId           String
  client             AgentClient @relation(fields: [clientId], references: [id], onDelete: Cascade)
  quoteId            String?     @unique
  quote              AgentQuote? @relation(fields: [quoteId], references: [id])

  // Trip Details
  tripName    String
  destination String
  startDate   DateTime
  endDate     DateTime
  duration    Int
  travelers   Int
  adults      Int
  children    Int
  infants     Int

  // Booking Components (Same structure as Quote)
  flights     Json[]
  hotels      Json[]
  activities  Json[]
  transfers   Json[]
  carRentals  Json[]
  insurance   Json?
  customItems Json[]

  // Pricing
  subtotal    Float
  agentMarkup Float
  taxes       Float
  fees        Float
  discount    Float
  total       Float
  totalPrice  Float? // Alias for total (for compatibility)
  commission  Float   @default(0) // Agent commission amount
  currency    String  @default("USD")

  // Payment Tracking
  paymentStatus   PaymentStatus @default(PENDING)
  depositAmount   Float         @default(0)
  depositPaid     Boolean       @default(false)
  depositPaidAt   DateTime?
  depositDueDate  DateTime?
  balanceDue      Float
  balancePaid     Boolean       @default(false)
  balancePaidAt   DateTime?
  finalPaymentDue DateTime?
  totalPaid       Float         @default(0)

  // Payment Processing
  paymentProvider      String? // stripe, paypal, etc
  stripePaymentId      String?
  paypalTransactionId  String?
  paymentMethod        String? // card, bank_transfer, check, wire
  paymentMethodDetails Json? // Card last 4, etc

  // Supplier Confirmations
  flightConfirmations    Json? // Array of flight confirmation numbers
  hotelConfirmations     Json? // Array of hotel confirmation numbers
  activityConfirmations  Json?
  transferConfirmations  Json?
  carRentalConfirmations Json?

  // Booking Status
  status BookingStatus @default(PENDING)

  // Trip Tracking
  tripStarted        Boolean   @default(false)
  tripStartedAt      DateTime?
  tripCompleted      Boolean   @default(false)
  tripCompletedAt    DateTime?
  tripCancelled      Boolean   @default(false)
  tripCancelledAt    DateTime?
  cancellationReason String?   @db.Text

  // Documents
  invoiceUrl            String?
  itineraryUrl          String?
  voucherUrls           Json? // Array of voucher URLs
  confirmationEmailSent Boolean @default(false)
  remindersSent         Int     @default(0)

  // Customer Service
  supportTickets     Json? // Array of support ticket IDs
  issuesReported     Int     @default(0)
  issuesResolved     Int     @default(0)
  clientSatisfaction Float? // 0-5 rating
  reviewReceived     Boolean @default(false)
  review             String? @db.Text
  reviewRating       Int? // 1-5

  // Commission & Payout
  agentCommissionPaid   Boolean   @default(false)
  agentCommissionPaidAt DateTime?
  holdPeriodEndsAt      DateTime?

  // Relations
  commissions     AgentCommission[]
  clientDocuments AgentClientDocument[]

  // Metadata
  source     String? // web, mobile, api, phone
  deviceType String?
  ipAddress  String?
  notes      String? @db.Text

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  @@index([agentId, status])
  @@index([clientId, status])
  @@index([confirmationNumber])
  @@index([status])
  @@index([paymentStatus])
  @@index([startDate])
  @@index([endDate])
  @@index([tripCompleted])
  @@map("agent_bookings")
}

enum BookingStatus {
  PENDING // Awaiting payment/confirmation
  CONFIRMED // Fully confirmed
  PARTIALLY_PAID // Deposit paid
  FULLY_PAID // Paid in full
  IN_PROGRESS // Trip happening now
  COMPLETED // Trip finished
  CANCELLED // Cancelled
  REFUNDED // Refunded
  NO_SHOW // Customer no-show
}

enum PaymentStatus {
  PENDING // No payment yet
  DEPOSIT_PAID // Deposit received
  FULLY_PAID // Paid in full
  PARTIALLY_REFUNDED // Partially refunded
  REFUNDED // Fully refunded
  FAILED // Payment failed
  DISPUTED // Chargeback/dispute
}

// Agent Commission Tracking
model AgentCommission {
  id        String       @id @default(cuid())
  agentId   String
  agent     TravelAgent  @relation(fields: [agentId], references: [id], onDelete: Cascade)
  bookingId String
  booking   AgentBooking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  // Revenue Breakdown
  bookingTotal       Float // Total booking value
  supplierCost       Float // Cost paid to suppliers
  grossProfit        Float // bookingTotal - supplierCost
  platformFee        Float // Platform's fee
  platformFeePercent Float // e.g., 0.05 = 5%
  agentEarnings      Float // What agent keeps

  // Commission Calculation
  commissionRate   Float // Agent's markup rate
  commissionAmount Float // Agent's commission before platform fee
  bonusAmount      Float @default(0)
  totalEarnings    Float // Final amount to agent

  // Product Breakdown (by component)
  flightCommission   Float @default(0)
  hotelCommission    Float @default(0)
  activityCommission Float @default(0)
  transferCommission Float @default(0)
  otherCommission    Float @default(0)

  // Lifecycle Status
  status CommissionStatus @default(PENDING)

  // Important Dates
  bookingDate   DateTime
  tripStartDate DateTime
  tripEndDate   DateTime
  holdUntil     DateTime? // When commission becomes available
  availableAt   DateTime? // When can be paid out
  releasedAt    DateTime? // When commission was released from hold
  paidAt        DateTime?

  // Payout Reference
  payoutId String?
  payout   AgentPayout? @relation(fields: [payoutId], references: [id])

  // Cancellation/Refund Tracking
  cancelled      Boolean   @default(false)
  cancelledAt    DateTime?
  refunded       Boolean   @default(false)
  refundedAt     DateTime?
  refundAmount   Float     @default(0)
  clawback       Boolean   @default(false) // If paid but later refunded
  clawbackAmount Float     @default(0)

  // Metadata
  notes String? @db.Text

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([agentId, status])
  @@index([bookingId])
  @@index([status])
  @@index([holdUntil])
  @@index([availableAt])
  @@map("agent_commissions")
}

enum CommissionStatus {
  PENDING // Booking made, trip not started
  TRIP_IN_PROGRESS // Trip happening
  IN_HOLD_PERIOD // Trip completed, in hold period
  AVAILABLE // Ready to be paid
  PAID // Commission paid
  CANCELLED // Booking cancelled
  REFUNDED // Booking refunded
}

// Agent Payout Management
model AgentPayout {
  id           String      @id @default(cuid())
  payoutNumber String?     @unique // PO-2025-001234
  agentId      String
  agent        TravelAgent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  // Payout Details
  amount              Float
  commissionsIncluded AgentCommission[]
  commissionCount     Int // Number of commissions in this payout

  // Period Covered
  periodStart DateTime
  periodEnd   DateTime

  // Payment Information
  method           String // stripe, paypal, bank_transfer, check
  payoutEmail      String? // For PayPal
  stripeTransferId String? // Stripe payout ID
  paypalBatchId    String? // PayPal batch payout ID
  bankTransferRef  String? // Bank transfer reference
  checkNumber      String? // Check number

  // Processing
  status        PayoutStatus @default(PENDING)
  requestedAt   DateTime     @default(now())
  processedAt   DateTime?
  completedAt   DateTime?
  failedAt      DateTime?
  failureReason String?      @db.Text

  // Fees & Net Amount
  processingFee Float  @default(0)
  netAmount     Float // amount - processingFee
  currency      String @default("USD")

  // Invoice/Receipt
  invoiceNumber  String? @unique // INV-2025-001234
  receiptUrl     String?
  taxDocumentUrl String? // 1099 for US agents

  // Admin Management
  processedBy String? // Admin user ID
  approvedBy  String? // Admin user ID
  approvedAt  DateTime?
  adminNotes  String?   @db.Text

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([agentId, status])
  @@index([status])
  @@index([periodStart, periodEnd])
  @@index([requestedAt])
  @@map("agent_payouts")
}

enum PayoutStatus {
  PENDING // Requested, awaiting approval
  APPROVED // Approved by admin
  PROCESSING // Being processed
  COMPLETED // Successfully paid
  FAILED // Payment failed
  CANCELLED // Cancelled by agent or admin
}

// Team/Agency Management
model AgentTeamMember {
  id       String      @id @default(cuid())
  agencyId String
  agency   TravelAgent @relation("AgencyTeam", fields: [agencyId], references: [id], onDelete: Cascade)
  agentId  String
  agent    TravelAgent @relation("AgentMemberships", fields: [agentId], references: [id], onDelete: Cascade)

  // Role & Permissions
  role        TeamRole @default(AGENT)
  permissions Json? // Custom permissions

  // Commission Split
  commissionSplit Float   @default(0.70) // Agent gets 70%, agency gets 30%
  overrideRate    Boolean @default(false)
  customRate      Float? // Custom commission rate for this agent

  // Access Control
  canManageClients  Boolean @default(true)
  canCreateQuotes   Boolean @default(true)
  canAcceptBookings Boolean @default(true)
  canViewReports    Boolean @default(false)
  canManageTeam     Boolean @default(false)

  // Status
  active        Boolean   @default(true)
  invitedAt     DateTime  @default(now())
  joinedAt      DateTime?
  suspendedAt   DateTime?
  removedAt     DateTime?
  removalReason String?   @db.Text

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([agencyId, agentId])
  @@index([agencyId, active])
  @@index([agentId])
  @@map("agent_team_members")
}

enum TeamRole {
  OWNER // Agency owner (full access)
  MANAGER // Can manage team and view all data
  AGENT // Regular agent
  VIEWER // Read-only access
}

// Client Notes & Communication Log
model AgentClientNote {
  id        String      @id @default(cuid())
  clientId  String
  client    AgentClient @relation(fields: [clientId], references: [id], onDelete: Cascade)
  agentId   String // Who created the note
  quoteId   String? // Related quote
  bookingId String? // Related booking

  // Note Content
  note        String  @db.Text
  noteType    String  @default("general") // general, call, email, meeting, follow_up, issue
  isImportant Boolean @default(false)
  isPinned    Boolean @default(false)

  // Communication Details
  contactMethod String? // phone, email, sms, whatsapp, in_person
  duration      Int? // Minutes (for calls/meetings)
  outcome       String? // successful, unsuccessful, callback_required, etc

  // Follow-up
  requiresFollowUp  Boolean   @default(false)
  followUpDate      DateTime?
  followUpCompleted Boolean   @default(false)

  // Attachments
  attachments Json? // Array of file URLs

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId, createdAt])
  @@index([agentId])
  @@index([requiresFollowUp, followUpDate])
  @@map("agent_client_notes")
}

// Client Document Storage
model AgentClientDocument {
  id         String        @id @default(cuid())
  clientId   String
  client     AgentClient   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  bookingId  String?
  booking    AgentBooking? @relation(fields: [bookingId], references: [id])
  uploadedBy String // Agent user ID

  // Document Details
  documentType String // passport, visa, invoice, itinerary, voucher, contract, etc
  fileName     String
  fileUrl      String // Secure storage URL
  fileSize     Int // Bytes
  mimeType     String

  // Document Info
  title       String?
  description String?   @db.Text
  expiryDate  DateTime? // For passports, visas, etc

  // Access Control
  sharedWithClient Boolean @default(false)
  isConfidential   Boolean @default(false)

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  @@index([clientId])
  @@index([bookingId])
  @@index([documentType])
  @@map("agent_client_documents")
}

// Custom Itinerary Templates
model AgentItineraryTemplate {
  id      String      @id @default(cuid())
  agentId String
  agent   TravelAgent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  // Template Details
  name        String
  description String? @db.Text
  category    String? // honeymoon, family, luxury, adventure, business

  // Design
  design      String  @default("modern_minimalist") // Design template name
  brandColor  String? // Hex color
  logoUrl     String? // Custom logo
  headerImage String? // Header image URL

  // Content Sections (JSON structure defining sections)
  sections Json

  // Usage
  isDefault  Boolean   @default(false)
  isPublic   Boolean   @default(false)
  usageCount Int       @default(0)
  lastUsed   DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([agentId])
  @@index([category])
  @@map("agent_itinerary_templates")
}

// Agent Supplier Management
model AgentSupplier {
  id      String      @id @default(cuid())
  agentId String
  agent   TravelAgent @relation("AgentSuppliers", fields: [agentId], references: [id], onDelete: Cascade)

  // Supplier Details
  name         String
  category     String  @default("other") // flights, hotels, activities, transfers, insurance, car_rentals, other
  contactName  String?
  contactEmail String?
  contactPhone String?

  // Business Information
  website     String?
  address     String? @db.Text
  city        String?
  country     String?
  apiEndpoint String?
  apiKey      String?

  // Terms
  commissionRate Float   @default(0.10) // 10% default commission
  paymentTerms   String? // e.g., "Net 30", "Net 60"

  // Status
  isPreferred Boolean @default(false)
  isActive    Boolean @default(true)
  rating      Float? // 0-5 rating

  // Metadata
  notes    String? @db.Text
  metadata Json?

  // Relations
  products AgentProduct[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([agentId])
  @@map("agent_suppliers")
}

// Agent Product Catalog
model AgentProduct {
  id         String        @id @default(cuid())
  agentId    String
  agent      TravelAgent   @relation("AgentProducts", fields: [agentId], references: [id], onDelete: Cascade)
  supplierId String
  supplier   AgentSupplier @relation(fields: [supplierId], references: [id], onDelete: Restrict)

  // Product Details
  name        String
  description String? @db.Text
  category    String  @default("other") // same as supplier categories
  type        String  @default("service") // service, package, add-on, upgrade

  // Pricing
  costPrice      Float  @default(0) // What agent pays supplier
  sellPrice      Float  @default(0) // What agent charges client
  currency       String @default("USD")
  commissionRate Float  @default(0.10) // Markup percentage

  // Availability
  isActive   Boolean @default(true)
  isFeatured Boolean @default(false)
  stock      Int? // For physical products or limited availability
  minOrder   Int?    @default(1)
  maxOrder   Int?

  // Media
  imageUrl String?

  // External IDs
  externalId String? // Supplier's product ID
  sku        String? // Stock keeping unit

  // Metadata
  tags     String[]
  metadata Json?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([agentId])
  @@index([supplierId])
  @@index([isActive])
  @@map("agent_products")
}

// Activity Log for Audit Trail
model AgentActivityLog {
  id      String      @id @default(cuid())
  agentId String
  agent   TravelAgent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  // Activity Details
  activityType String // quote_created, booking_confirmed, payout_requested, client_added, etc
  description  String  @db.Text
  entityType   String? // quote, booking, client, payout
  entityId     String? // ID of related entity
  metadata     Json? // Additional context

  // Context
  ipAddress String?
  userAgent String?
  location  String?

  // Timestamps
  createdAt DateTime @default(now())

  @@index([agentId, createdAt])
  @@index([activityType])
  @@index([entityType, entityId])
  @@map("agent_activity_logs")
}
// ============================================
// FIFA WORLD CUP 2026 MODELS
// ============================================

// World Cup Teams (32 qualified nations)
model WorldCupTeam {
  id              String   @id @default(cuid())

  // Team Identity
  name            String   @unique // "Brazil"
  shortName       String   // "BRA"
  fifaCode        String   @unique // "BRA"

  // Visual Identity
  flagEmoji       String   // "🇧🇷"
  primaryColor    String   // "#009C3B" (Brazil green)
  secondaryColor  String   // "#FFDF00" (Brazil yellow)
  accentColor     String?  // Additional color
  flagUrl         String   // URL to flag image
  logoUrl         String?  // Team crest/logo

  // Team Info
  fifaRanking     Int?
  confederation   String   // "CONMEBOL", "UEFA", "CONCACAF", etc
  group           String?  // "Group A", "Group B", etc (assigned later)
  headCoach       String?
  captain         String?
  starPlayers     Json?    // Array of key players

  // Stats & History
  worldCupWins    Int      @default(0)
  worldCupApps    Int      @default(0) // Appearances
  bestFinish      String?  // "Champions", "Runners-up", "Semi-finals"
  description     String?  @db.Text

  // SEO & Content
  slug            String   @unique // "brazil"
  metaTitle       String?
  metaDescription String?  @db.Text
  content         String?  @db.Text // Rich content about team

  // Relations
  homeMatches     WorldCupMatch[] @relation("HomeTeam")
  awayMatches     WorldCupMatch[] @relation("AwayTeam")
  bookings        WorldCupBooking[]

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([slug])
  @@index([group])
  @@index([confederation])
  @@map("world_cup_teams")
}

// World Cup Stadiums (16 venues)
model WorldCupStadium {
  id              String   @id @default(cuid())

  // Stadium Identity
  name            String   @unique // "SoFi Stadium"
  nickname        String?  // "The Crown Jewel"

  // Location
  city            String   // "Los Angeles"
  state           String?  // "California"
  country         String   // "USA", "Canada", "Mexico"
  address         String?
  latitude        Float?
  longitude       Float?
  timezone        String   // "America/Los_Angeles"

  // Stadium Info
  capacity        Int      // 70000
  opened          Int?     // Year opened
  surface         String?  // "Grass", "Artificial"
  roofType        String?  // "Retractable", "Open", "Closed"

  // Visuals
  imageUrl        String?  // Main stadium image
  images          Json?    // Array of image URLs
  seatingChart    String?  // URL to seating diagram
  virtualTour     String?  // URL to 360° tour

  // Travel Info
  nearestAirport  String?  // "LAX"
  airportDistance Float?   // km
  publicTransit   String?  @db.Text
  parkingInfo     String?  @db.Text

  // Area Info
  nearbyHotels    Json?    // Array of hotel areas
  restaurants     Json?    // Nearby dining
  attractions     Json?    // Things to do

  // City Colors (for theming)
  cityPrimaryColor    String?  // LA = purple/gold
  citySecondaryColor  String?

  // SEO & Content
  slug            String   @unique // "sofi-stadium"
  metaTitle       String?
  metaDescription String?  @db.Text
  description     String?  @db.Text
  travelGuide     String?  @db.Text

  // Relations
  matches         WorldCupMatch[]

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([slug])
  @@index([city])
  @@index([country])
  @@map("world_cup_stadiums")
}

// World Cup Matches (104 total matches)
model WorldCupMatch {
  id              String   @id @default(cuid())

  // Match Identity
  matchNumber     Int      @unique // 1-104
  fifaMatchId     String?  @unique

  // Teams (optional until group draw)
  homeTeamId      String?
  homeTeam        WorldCupTeam? @relation("HomeTeam", fields: [homeTeamId], references: [id])
  awayTeamId      String?
  awayTeam        WorldCupTeam? @relation("AwayTeam", fields: [awayTeamId], references: [id])

  // Venue
  stadiumId       String
  stadium         WorldCupStadium @relation(fields: [stadiumId], references: [id])

  // Schedule
  matchDate       DateTime
  matchTime       String   // "20:00"
  localTime       String   // "8:00 PM ET"

  // Match Details
  stage           MatchStage // GROUP_STAGE, ROUND_16, etc
  groupName       String?  // "Group A" (for group stage)
  roundName       String   // "Opening Match", "Final", etc

  // Match Status
  status          MatchStatus @default(SCHEDULED)
  homeScore       Int?
  awayScore       Int?
  penalties       Json?    // Penalty shootout info

  // Ticket Info
  ticketsAvailable Boolean  @default(true)
  ticketPriceMin  Float?   // Minimum ticket price
  ticketPriceMax  Float?   // Maximum ticket price
  ticketProviders Json?    // Array of ticket sources

  // Visuals
  matchPosterUrl  String?  // Custom match artwork
  broadcastInfo   Json?    // TV channels, streaming

  // SEO & Content
  slug            String   @unique // "opening-match-mexico-vs-tbd"
  metaTitle       String?
  metaDescription String?  @db.Text
  preview         String?  @db.Text // Match preview content
  recap           String?  @db.Text // Post-match recap

  // Relations
  bookings        WorldCupBooking[]
  tickets         WorldCupTicket[]

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([matchDate])
  @@index([stadiumId])
  @@index([stage])
  @@index([slug])
  @@map("world_cup_matches")
}

enum MatchStage {
  GROUP_STAGE
  ROUND_16
  QUARTER_FINAL
  SEMI_FINAL
  THIRD_PLACE
  FINAL
}

enum MatchStatus {
  SCHEDULED
  LIVE
  HALFTIME
  FINISHED
  POSTPONED
  CANCELLED
}

// World Cup Tickets (from various providers)
model WorldCupTicket {
  id              String   @id @default(cuid())

  // Ticket Source
  provider        String   // "Vivid Seats", "Ticketmaster", "SeatGeek"
  providerTicketId String  // External ticket ID

  // Match
  matchId         String
  match           WorldCupMatch @relation(fields: [matchId], references: [id])

  // Seat Details
  section         String
  row             String?
  seatNumber      String?
  quantity        Int      @default(1)
  seatType        String?  // "Standard", "Premium", "VIP", "Suite"

  // Pricing
  faceValue       Float?   // Original ticket price
  wholesalePrice  Float    // What we pay provider
  retailPrice     Float    // What customer pays
  markup          Float    // Our profit
  currency        String   @default("USD")

  // Availability
  available       Boolean  @default(true)
  reserved        Boolean  @default(false)
  reservedUntil   DateTime?
  sold            Boolean  @default(false)

  // Features
  features        Json?    // ["Parking", "Club Access", etc]
  seatView        String?  // URL to seat view image

  // Relations
  booking         WorldCupBooking? @relation(fields: [bookingId], references: [id])
  bookingId       String?

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([matchId, available])
  @@index([provider])
  @@index([retailPrice])
  @@map("world_cup_tickets")
}

// World Cup Package/Booking
model WorldCupBooking {
  id              String   @id @default(cuid())

  // User
  userId          String
  user            User     @relation(fields: [userId], references: [id])

  // Package Details
  packageType     String   // "SINGLE_MATCH", "MULTI_MATCH", "FOLLOW_TEAM", "CUSTOM"
  packageName     String   // "Brazil Group Stage Package"

  // Matches
  matchId         String?  // Primary match (for single-match bookings)
  match           WorldCupMatch? @relation(fields: [matchId], references: [id])
  teamId          String?  // If "follow team" package
  team            WorldCupTeam? @relation(fields: [teamId], references: [id])

  // Components
  tickets         WorldCupTicket[]
  flightBooking   Json?    // Flight details from existing system
  hotelBooking    Json?    // Hotel details from existing system
  carRental       Json?    // Car rental details
  experiences     Json?    // Tours, activities

  // Pricing
  ticketsTotal    Float    @default(0)
  flightsTotal    Float    @default(0)
  hotelsTotal     Float    @default(0)
  carsTotal       Float    @default(0)
  experiencesTotal Float   @default(0)
  subtotal        Float
  taxes           Float    @default(0)
  fees            Float    @default(0)
  total           Float
  currency        String   @default("USD")

  // Payment
  paymentStatus   String   @default("PENDING") // PENDING, PAID, REFUNDED
  paymentMethod   String?
  stripePaymentId String?
  paidAt          DateTime?

  // Status
  status          String   @default("CONFIRMED") // PENDING, CONFIRMED, CANCELLED
  confirmationNumber String @unique

  // Delivery
  ticketsDelivered Boolean @default(false)
  deliveryMethod  String?  // "EMAIL", "MOBILE", "MAIL"
  deliveredAt     DateTime?

  // Customer Info
  customerName    String
  customerEmail   String
  customerPhone   String?

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  cancelledAt     DateTime?

  @@index([userId])
  @@index([matchId])
  @@index([teamId])
  @@index([status])
  @@index([confirmationNumber])
  @@map("world_cup_bookings")
}

// ==========================================
// Credit Card Authorization System
// For Manual Payment Processing & Chargeback Protection
// ==========================================

model CardAuthorization {
  id                String   @id @default(cuid())
  bookingReference  String   @unique // FLY-XXXXXX

  // Cardholder Information
  cardholderName    String
  cardLast4         String   // Last 4 digits only
  cardBrand         String   // visa, mastercard, amex, discover
  expiryMonth       Int
  expiryYear        Int

  // Billing Address
  billingStreet     String
  billingCity       String
  billingState      String
  billingZip        String
  billingCountry    String

  // Contact
  email             String
  phone             String

  // Transaction Details
  amount            Float
  currency          String   @default("USD")

  // Document Uploads (secure URLs)
  cardFrontImage    String?  // URL to encrypted card front image
  cardBackImage     String?  // URL to encrypted card back image
  idDocumentImage   String?  // URL to ID document image

  // Digital Signature
  signatureImage    String?  // Base64 or URL of signature
  signatureTyped    String   // Typed full name

  // Acknowledgments (must all be true)
  ackAuthorize      Boolean  @default(false)
  ackCardholder     Boolean  @default(false)
  ackNonRefundable  Boolean  @default(false)
  ackPassengerInfo  Boolean  @default(false)
  ackTerms          Boolean  @default(false)

  // Device & Security Info
  ipAddress         String
  userAgent         String?
  deviceFingerprint String?

  // Verification Status
  status            CardAuthStatus @default(PENDING)
  verifiedAt        DateTime?
  verifiedBy        String?  // Admin user ID
  rejectionReason   String?

  // Risk Assessment
  riskScore         Int?     // 0-100, higher = more risk
  riskFactors       Json?    // Array of risk factors detected

  // Timestamps
  submittedAt       DateTime @default(now())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([bookingReference])
  @@index([status])
  @@index([email])
  @@index([submittedAt])
  @@map("card_authorizations")
}

enum CardAuthStatus {
  PENDING      // Awaiting admin review
  VERIFIED     // Approved by admin
  REJECTED     // Rejected (fraud suspected)
  EXPIRED      // Not processed in time
}

// ==========================================
// AIRLINE CONSOLIDATOR COMMISSION SYSTEM
// Hybrid Routing Engine: Consolidator vs Duffel
// Decision: If commission > $5 → Consolidator; else → Duffel
// ==========================================

// Airline commission contracts from consolidator (Downtown Travel)
model AirlineContract {
  id            String   @id @default(cuid())
  airlineCode   String   // IATA code: "AA", "BA", "LH"
  airlineName   String
  allianceCode  String?  // "oneworld", "star_alliance", "skyteam"
  ticketStock   String?  // e.g., "001" for AA, "125" for BA

  // Contract validity
  validFrom     DateTime
  validTo       DateTime
  isActive      Boolean  @default(true)

  // Tour codes for commission claims
  tourCode      String?
  ticketDesignator String?

  // Channel restrictions
  gdsAllowed    Boolean  @default(true)
  ndcAllowed    Boolean  @default(true)
  ndcDirectAllowed Boolean @default(false)

  // Notes
  notes         String?  @db.Text

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  routes        AirlineCommissionRoute[]

  @@unique([airlineCode, validFrom])
  @@index([airlineCode])
  @@index([isActive])
  @@index([validFrom, validTo])
  @@map("airline_contracts")
}

// Route-specific commission rules
model AirlineCommissionRoute {
  id              String   @id @default(cuid())
  contractId      String
  contract        AirlineContract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  // Origin patterns
  originType      AirlineRouteType @default(ANY)
  originCodes     String[]  // ["JFK", "EWR"] or ["US"] or ["NORTH_AMERICA"]
  originExclusions String[] // Airports/cities to exclude

  // Destination patterns
  destinationType AirlineRouteType @default(ANY)
  destinationCodes String[]
  destinationExclusions String[]

  // Direction
  bidirectional   Boolean  @default(true)

  // Operator requirements
  operatingCarrierRequired Boolean @default(false) // Must be airline-operated
  marketingCarrierRequired Boolean @default(false) // Must be airline-marketed

  // Interline rules
  interlineAllowed Boolean @default(true)
  interlineCommissionReduction Float? // e.g., -3 percentage points

  // Validity (can override contract)
  validFrom       DateTime?
  validTo         DateTime?

  // Tour code override
  tourCodeOverride String?

  // Priority for matching (higher = checked first)
  priority        Int      @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  fareClasses     AirlineCommissionFareClass[]

  @@index([contractId])
  @@index([originCodes])
  @@index([destinationCodes])
  @@map("airline_commission_routes")
}

// Commission rates by fare class
model AirlineCommissionFareClass {
  id              String   @id @default(cuid())
  routeId         String
  route           AirlineCommissionRoute @relation(fields: [routeId], references: [id], onDelete: Cascade)

  // Fare class matching
  bookingCodes    String[] // ["F", "A", "J"] or ["Y", "B", "H", "K"]
  cabinClass      CabinClass
  fareFamily      String?  // "flex", "semi_flex", "basic", "light"

  // Commission rates by season (percentage)
  defaultPct      Float    // Used when no season specified
  lowSeasonPct    Float?
  shoulderSeasonPct Float?
  highSeasonPct   Float?
  peakSeasonPct   Float?

  // Season date ranges (MM-DD format)
  lowSeasonDates    Json?  // [{start: "01-01", end: "03-31"}, ...]
  shoulderSeasonDates Json?
  highSeasonDates   Json?
  peakSeasonDates   Json?

  // Blackout dates (0% commission)
  blackoutDates   Json?    // [{start: "2025-05-26", end: "2025-06-03"}, ...]

  // Special rules
  infantCommission Boolean @default(false) // Infant fares commissionable?
  childCommission  Boolean @default(true)  // Child fares commissionable?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([routeId])
  @@index([cabinClass])
  @@map("airline_commission_fare_classes")
}

// Exclusion rules (apply to all or specific airlines)
model AirlineCommissionExclusion {
  id              String   @id @default(cuid())
  airlineCode     String?  // null = applies to ALL airlines

  exclusionType   AirlineExclusionType
  description     String

  // Fare basis code rules
  fareBasisRule   String?  // e.g., "7th_char_B" for Basic Economy
  fareBasisPattern String? // Regex pattern

  // Booking code rules
  excludedBookingCodes String[] // e.g., ["G", "W"] for non-commissionable

  // Fare family rules
  excludedFareFamilies String[] // e.g., ["BASIC", "LIGHT", "QP", "SL"]

  isActive        Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([airlineCode])
  @@index([exclusionType])
  @@index([isActive])
  @@map("airline_commission_exclusions")
}

// Geographic market definitions (for complex routing logic)
model GeographicMarket {
  id          String   @id @default(cuid())
  marketCode  String   @unique // "AJB", "QASA", "LAC", "EMEAI"
  marketName  String   // "Asia-Japan Business", "Latin America & Caribbean"

  // Countries included
  countryCodes String[] // ISO country codes

  // Regions included
  regions     String[]  // ["NORTH_AMERICA", "WESTERN_EUROPE"]

  // Airport exceptions
  includedAirports String[] // Specific airports to include
  excludedAirports String[] // Specific airports to exclude

  description String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("geographic_markets")
}

// LCC airlines (Duffel-only, no consolidator support)
model LCCAirline {
  id          String   @id @default(cuid())
  airlineCode String   @unique // "NK", "F9", "G4", "WN"
  airlineName String
  notes       String?
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("lcc_airlines")
}

// Routing decision audit log
model RoutingDecision {
  id              String   @id @default(cuid())

  // Search context
  searchId        String?  // Reference to search session
  offerId         String   // Duffel or GDS offer ID

  // Flight details
  airlineCode     String
  origin          String
  destination     String
  departureDate   DateTime
  cabinClass      CabinClass
  fareClass       String?
  fareBasisCode   String?

  // Pricing
  baseFare        Float
  totalFare       Float
  currency        String   @default("USD")

  // Commission calculation
  commissionPct   Float?
  commissionAmount Float?
  isExcluded      Boolean  @default(false)
  exclusionReason String?

  // Routing decision
  routingChannel  RoutingChannel
  estimatedProfit Float
  decisionReason  String   // "high_commission", "lcc_airline", "basic_economy", etc.

  // Comparison data
  duffelProfit    Float?   // Profit if booked via Duffel
  consolidatorProfit Float? // Profit if booked via Consolidator

  // Was booking completed?
  bookingId       String?  // Reference to booking if completed
  wasBooked       Boolean  @default(false)

  createdAt       DateTime @default(now())

  @@index([airlineCode])
  @@index([routingChannel])
  @@index([createdAt])
  @@index([searchId])
  @@map("routing_decisions")
}

// Enums for airline commission system
enum AirlineRouteType {
  ANY           // Any origin/destination
  AIRPORT       // Specific airport codes
  CITY          // City codes
  COUNTRY       // Country codes
  REGION        // Geographic regions
  MARKET        // Custom market definitions
}

enum CabinClass {
  FIRST
  BUSINESS
  PREMIUM_ECONOMY
  ECONOMY
  BASIC_ECONOMY
}

enum AirlineExclusionType {
  BASIC_ECONOMY      // 7th char = B
  LIGHT_FARE         // Light/Basic fare families
  GROUP_FARE         // 10+ passengers
  NET_FARE           // Net/negotiated rates
  CORPORATE_FARE     // Corporate contracted rates
  MILITARY_FARE      // Military/government
  INFANT_FARE        // INF fare type
  WEB_FARE           // Web-only fares
  PROMO_FARE         // Special promotions
  NON_REVENUE        // Staff/industry fares
}

enum RoutingChannel {
  DUFFEL         // Book via Duffel API
  CONSOLIDATOR   // Book via Downtown Travel GDS
}

// ==========================================
// Admin System Configuration
// ==========================================

// System-wide configuration storage
model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique  // Config key (e.g., "loyalty_config", "hotel_settings")
  value       Json     // JSON configuration value
  description String?  // Description of what this config controls
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([key])
  @@map("system_configs")
}

// Promo Code Usage Tracking
model PromoCodeUsage {
  id              String    @id @default(cuid())
  promoCodeId     String
  promoCode       PromoCode @relation(fields: [promoCodeId], references: [id], onDelete: Cascade)
  userId          String?   // Null for guest bookings
  user            User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  bookingId       String?   // Reference to the booking
  bookingType     String    // hotel, flight, car, activity
  discountApplied Float     // Actual discount amount applied
  orderTotal      Float     // Total order value before discount
  currency        String    @default("USD")
  usedAt          DateTime  @default(now())

  @@index([promoCodeId])
  @@index([userId])
  @@index([usedAt])
  @@map("promo_code_usages")
}

// ==========================================
// Newsletter Subscribers
// ==========================================

model NewsletterSubscriber {
  id              String    @id @default(cuid())
  email           String    @unique
  firstName       String?
  source          String    @default("website") // website, world-cup, modal, footer, etc.
  status          String    @default("ACTIVE") // ACTIVE, UNSUBSCRIBED, BOUNCED
  subscribedAt    DateTime  @default(now())
  unsubscribedAt  DateTime?
  reactivatedAt   DateTime?
  lastEmailSentAt DateTime?
  emailsSent      Int       @default(0)
  emailsOpened    Int       @default(0)
  emailsClicked   Int       @default(0)

  // Preferences
  dealAlerts       Boolean @default(true)
  newRoutes        Boolean @default(true)
  weeklyDigest     Boolean @default(true)
  worldCupUpdates  Boolean @default(true)

  // Metadata
  ipAddress        String?
  userAgent        String?
  country          String?

  @@index([status])
  @@index([subscribedAt])
  @@index([source])
  @@map("newsletter_subscribers")
}

// ==========================================
// Fly2Any Airline Data System
// Comprehensive airline profiles for internal API & ML
// ==========================================

model AirlineProfile {
  id                String   @id @default(cuid())

  // Core identifiers
  iataCode          String   @unique // "AA", "BA", "LH"
  icaoCode          String?  // "AAL", "BAW", "DLH"
  callsign          String?  // "AMERICAN", "SPEEDBIRD"

  // Basic info
  name              String   // "American Airlines"
  shortName         String?  // "American"
  legalName         String?  // "American Airlines, Inc."

  // Alliance & branding
  alliance          String?  // "oneworld", "star_alliance", "skyteam"
  logoUrl           String?
  logoUrlSvg        String?
  brandPrimaryColor String?  // "#0078D2"
  brandSecondaryColor String?

  // HQ & contact
  country           String?  // "US"
  countryName       String?
  headquarters      String?
  foundedYear       Int?
  websiteUrl        String?
  customerServicePhone String?

  // Hub airports
  hubAirports       String[] // ["DFW", "CLT", "MIA"]

  // Loyalty program
  loyaltyProgramName String?  // "AAdvantage"
  loyaltyTiers       Json?

  // Fleet summary
  fleetSize         Int?
  averageFleetAge   Float?
  aircraftTypes     String[]

  // Service features
  cabinClasses      String[]
  hasPremiumEconomy Boolean  @default(false)
  hasLieFlat        Boolean  @default(false)
  hasWifi           Boolean  @default(false)
  wifiType          String?
  hasIFE            Boolean  @default(false)
  hasPowerOutlets   Boolean  @default(false)
  mealService       String?
  alcoholPolicy     String?

  // Baggage
  carryOnIncluded     Boolean @default(true)
  checkedBagIncluded  Boolean @default(false)
  firstBagFeeUSD      Float?
  secondBagFeeUSD     Float?

  // Ratings (0-5)
  overallRating       Float?
  onTimeRating        Float?
  comfortRating       Float?
  serviceRating       Float?
  valueRating         Float?

  // Operational stats
  onTimePercentage    Float?
  cancellationRate    Float?
  avgDelayMinutes     Float?

  // API sources
  duffelId          String?
  amadeusId         String?

  // Type & status
  airlineType       AirlineType @default(FSC)
  isActive          Boolean  @default(true)

  // ML enhancement
  descriptionEmbedding Float[]
  tags              String[]

  // Metadata
  lastSyncedAt      DateTime?
  dataSource        String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  routes            AirlineRouteProfile[]
  fleet             AirlineFleet[]
  operationalStats  AirlineOperationalStats[]
  knowledgeEntries  AirlineKnowledgeEntry[]

  @@index([iataCode])
  @@index([alliance])
  @@index([country])
  @@index([airlineType])
  @@map("airline_profiles")
}

enum AirlineType {
  FSC       // Full-Service Carrier
  LCC       // Low-Cost Carrier
  ULCC      // Ultra Low-Cost Carrier
  HYBRID
  REGIONAL
  CHARTER
  CARGO
}

model AirlineFleet {
  id              String   @id @default(cuid())
  airlineId       String
  airline         AirlineProfile @relation(fields: [airlineId], references: [id], onDelete: Cascade)

  aircraftType    String   // "Boeing 737-800"
  icaoType        String?  // "B738"
  manufacturer    String?
  model           String?
  count           Int
  averageAge      Float?
  seatConfig      Json?
  totalSeats      Int?
  rangeKm         Int?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([airlineId, aircraftType])
  @@index([airlineId])
  @@map("airline_fleet")
}

model AirlineRouteProfile {
  id              String   @id @default(cuid())
  airlineId       String
  airline         AirlineProfile @relation(fields: [airlineId], references: [id], onDelete: Cascade)

  originIata      String
  destinationIata String
  routeType       String?

  dailyFlights    Int?
  weeklyFlights   Int?
  seasonality     String?

  avgEconomyFare  Float?
  avgBusinessFare Float?
  priceVolatility Float?
  onTimePercentage Float?
  avgFlightDuration Int?
  aircraftTypes   String[]
  competitorCount Int?
  marketShare     Float?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([airlineId, originIata, destinationIata])
  @@index([airlineId])
  @@index([originIata])
  @@index([destinationIata])
  @@map("airline_routes")
}

model AirlineOperationalStats {
  id              String   @id @default(cuid())
  airlineId       String
  airline         AirlineProfile @relation(fields: [airlineId], references: [id], onDelete: Cascade)

  periodType      String   // "monthly", "quarterly", "yearly"
  periodStart     DateTime
  periodEnd       DateTime

  totalFlights    Int?
  onTimeFlights   Int?
  delayedFlights  Int?
  cancelledFlights Int?
  avgDelayMinutes Float?
  loadFactor      Float?
  complaints      Int?

  createdAt       DateTime @default(now())

  @@unique([airlineId, periodType, periodStart])
  @@index([airlineId])
  @@index([periodStart])
  @@map("airline_operational_stats")
}

// ==========================================
// ML Knowledge Base for Airlines
// ==========================================

model AirlineKnowledgeEntry {
  id              String   @id @default(cuid())
  airlineId       String?
  airline         AirlineProfile? @relation(fields: [airlineId], references: [id], onDelete: Cascade)

  title           String
  content         String   @db.Text
  category        String   // "policy", "service", "history", "fleet", "route", "loyalty"
  source          String?
  sourceUrl       String?
  embedding       Float[]
  language        String   @default("en")
  isVerified      Boolean  @default(false)
  confidence      Float?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([airlineId])
  @@index([category])
  @@map("airline_knowledge_entries")
}

model AirlineDataSyncLog {
  id              String   @id @default(cuid())
  source          String   // "duffel", "amadeus", "scraper"
  status          String   // "started", "completed", "failed"
  airlinesUpdated Int      @default(0)
  airlinesCreated Int      @default(0)
  errorMessage    String?
  duration        Int?     // milliseconds
  createdAt       DateTime @default(now())

  @@index([source])
  @@index([createdAt])
  @@map("airline_data_sync_logs")
}

// ==========================================
// Comprehensive Aviation Intelligence System
// ==========================================

// Global Aircraft Database
model Aircraft {
  id              String   @id @default(cuid())

  // Identifiers
  iataCode        String   @unique // "738", "359", "77W"
  icaoCode        String?  @unique // "B738", "A359", "B77W"

  // Basic info
  manufacturer    String   // "Boeing", "Airbus"
  model           String   // "737-800", "A350-900"
  fullName        String   // "Boeing 737-800"
  family          String?  // "737", "A350"
  variant         String?  // "-800", "-900XWB"

  // Category
  category        AircraftCategory @default(NARROWBODY)
  engineType      String?  // "turbofan", "turboprop"
  engineCount     Int?

  // Performance specs
  rangeKm         Int?     // Max range in km
  rangeMiles      Int?
  cruiseSpeedKmh  Int?
  cruiseSpeedMph  Int?
  maxAltitudeFt   Int?
  fuelCapacityL   Int?

  // Capacity
  maxPassengers   Int?     // Maximum config
  typicalSeats    Int?     // Typical 2-class
  cargoCapacityM3 Float?

  // Dimensions
  lengthM         Float?
  wingspanM       Float?
  heightM         Float?
  cabinWidthM     Float?

  // Comfort features
  hasWideBody     Boolean  @default(false)
  aisleCount      Int      @default(1)
  seatWidthInches Float?
  windowsPerRow   Int?

  // Operational
  firstFlight     DateTime?
  inProduction    Boolean  @default(true)
  unitsBuilt      Int?
  operators       String[] // Airlines using this type

  // Images
  imageUrl        String?
  schematicUrl    String?

  // Data source
  dataSource      String?
  lastUpdated     DateTime @default(now())
  createdAt       DateTime @default(now())

  // Relations
  seatMaps        AircraftSeatMap[]
  flightRecords   FlightRecord[]

  @@index([manufacturer])
  @@index([category])
  @@map("aircraft")
}

enum AircraftCategory {
  NARROWBODY      // Single aisle (737, A320)
  WIDEBODY        // Twin aisle (777, A350)
  REGIONAL_JET    // CRJ, ERJ
  TURBOPROP       // ATR, Dash 8
  BUSINESS_JET
  FREIGHTER
}

model AircraftSeatMap {
  id              String   @id @default(cuid())
  aircraftId      String
  aircraft        Aircraft @relation(fields: [aircraftId], references: [id], onDelete: Cascade)

  airlineCode     String?  // Airline-specific config
  configName      String?  // "2-class", "3-class", "high-density"

  // Cabin layout
  firstClassRows  Int      @default(0)
  firstClassSeats Int      @default(0)
  firstClassPitch Int?     // inches
  firstClassWidth Float?   // inches

  businessRows    Int      @default(0)
  businessSeats   Int      @default(0)
  businessPitch   Int?
  businessWidth   Float?
  businessLieFlat Boolean  @default(false)

  premiumEcoRows  Int      @default(0)
  premiumEcoSeats Int      @default(0)
  premiumEcoPitch Int?
  premiumEcoWidth Float?

  economyRows     Int      @default(0)
  economySeats    Int      @default(0)
  economyPitch    Int?
  economyWidth    Float?

  totalSeats      Int
  seatLayout      String?  // "3-3", "3-3-3", "2-4-2"

  // Exit rows & amenities
  exitRows        Int[]
  extraLegroom    Int[]    // Row numbers
  hasIFE          Boolean  @default(false)
  hasPower        Boolean  @default(false)
  hasWifi         Boolean  @default(false)

  // Visual data
  seatMapJson     Json?    // Full seat map data
  seatMapUrl      String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([aircraftId, airlineCode, configName])
  @@index([aircraftId])
  @@index([airlineCode])
  @@map("aircraft_seat_maps")
}

// Global Airport Database
model Airport {
  id              String   @id @default(cuid())

  // Identifiers
  iataCode        String   @unique // "JFK", "LHR"
  icaoCode        String?  @unique // "KJFK", "EGLL"

  // Basic info
  name            String   // "John F. Kennedy International"
  shortName       String?  // "JFK"
  city            String   // "New York"
  cityCode        String?  // Multi-airport cities: "NYC"
  state           String?  // "NY"
  country         String   // "US"
  countryName     String?  // "United States"
  continent       String?  // "North America"
  region          String?  // "Northeast"

  // Location
  latitude        Float?
  longitude       Float?
  elevation       Int?     // feet above sea level
  timezone        String?  // "America/New_York"
  utcOffset       Float?   // -5.0

  // Size & category
  airportType     AirportType @default(LARGE)
  isHub           Boolean  @default(false)
  isInternational Boolean  @default(true)
  hubFor          String[] // Airlines using as hub

  // Terminals
  terminalCount   Int?
  terminals       Json?    // Terminal details

  // Operational
  runways         Int?
  longestRunway   Int?     // feet
  annualPassengers Int?    // millions
  annualFlights   Int?

  // Amenities
  hasLounge       Boolean  @default(false)
  loungeCount     Int?
  hasHotel        Boolean  @default(false)
  hasFreeWifi     Boolean  @default(false)
  hasMetro        Boolean  @default(false)
  hasTrainStation Boolean  @default(false)

  // Distance to city center
  distanceToCity  Float?   // km
  avgTransferTime Int?     // minutes

  // Website & contacts
  websiteUrl      String?
  phoneNumber     String?

  // Images
  imageUrl        String?
  mapUrl          String?

  // Data source
  duffelId        String?
  amadeusId       String?
  dataSource      String?
  lastUpdated     DateTime @default(now())
  createdAt       DateTime @default(now())

  // Relations
  departureFlights FlightRecord[] @relation("DepartureAirport")
  arrivalFlights   FlightRecord[] @relation("ArrivalAirport")

  @@index([city])
  @@index([country])
  @@index([airportType])
  @@map("airports")
}

enum AirportType {
  LARGE           // Major international hub
  MEDIUM          // Regional hub
  SMALL           // Small/regional
  CARGO           // Cargo focused
  MILITARY        // Civil-military
}

// Fare Classes & Brands
model FareClass {
  id              String   @id @default(cuid())

  // Identifier
  code            String   // "Y", "B", "M", "K", "W", "J", "F"
  airlineCode     String?  // Airline-specific (null = generic)

  // Basic info
  name            String   // "Economy", "Premium Economy"
  brandName       String?  // "Main Cabin", "Comfort+"
  cabinClass      CabinClass
  tier            Int?     // 1=highest, 10=lowest within cabin

  // Booking class
  bookingClasses  String[] // ["Y", "B", "M", "H", "K"]
  isAward         Boolean  @default(false)
  isUpgrade       Boolean  @default(false)

  // Seat benefits
  seatSelection   String?  // "free", "paid", "at_checkin"
  seatPitch       Int?     // typical inches
  seatWidth       Float?
  seatRecline     Int?     // degrees
  legroom         String?  // "standard", "extra", "none"

  // Baggage
  carryOnIncluded Boolean  @default(true)
  carryOnSize     String?  // "22x14x9"
  checkedBags     Int      @default(0)
  firstBagWeight  Int?     // kg
  secondBagWeight Int?     // kg
  excessBagFee    Float?

  // Flexibility
  changeAllowed   Boolean  @default(false)
  changeFee       Float?
  changeAnytime   Boolean  @default(false)
  cancelAllowed   Boolean  @default(false)
  cancelFee       Float?
  refundable      Boolean  @default(false)
  refundType      String?  // "full", "voucher", "none"
  noShowProtection Boolean @default(false)

  // Earning
  milesEarning    Int?     // percentage of base
  eliteCredits    Int?     // percentage
  upgradeEligible Boolean  @default(false)
  loungAccess     Boolean  @default(false)

  // Priority
  priorityBoarding Boolean  @default(false)
  prioritySecurity Boolean  @default(false)
  priorityBaggage  Boolean  @default(false)

  // Onboard
  mealIncluded    Boolean  @default(false)
  mealType        String?  // "snack", "full", "premium"
  alcoholIncluded Boolean  @default(false)
  entertainmentFree Boolean @default(true)
  wifiFree        Boolean  @default(false)

  // Data
  dataSource      String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([code, airlineCode])
  @@index([airlineCode])
  @@index([cabinClass])
  @@map("fare_classes")
}

// Flight Schedule Records (historical/observed)
model FlightRecord {
  id              String   @id @default(cuid())

  // Flight identity
  flightNumber    String   // "AA100"
  airlineCode     String   // "AA"
  operatingCarrier String? // If codeshare
  operatingFlight String?

  // Route
  originId        String
  origin          Airport  @relation("DepartureAirport", fields: [originId], references: [id])
  destinationId   String
  destination     Airport  @relation("ArrivalAirport", fields: [destinationId], references: [id])
  originIata      String   // Denormalized for queries
  destinationIata String

  // Aircraft
  aircraftId      String?
  aircraft        Aircraft? @relation(fields: [aircraftId], references: [id])
  aircraftIata    String?  // "738"
  aircraftName    String?  // "Boeing 737-800"

  // Schedule
  departureDate   DateTime
  departureTime   String?  // "14:30"
  arrivalTime     String?  // "18:45"
  departureLocal  DateTime?
  arrivalLocal    DateTime?
  durationMinutes Int?

  // Status (for historical)
  status          String?  // "scheduled", "departed", "arrived", "cancelled"
  actualDeparture DateTime?
  actualArrival   DateTime?
  delayMinutes    Int?

  // Pricing observed
  economyPrice    Float?
  businessPrice   Float?
  firstPrice      Float?
  currency        String   @default("USD")
  fareClass       String?
  fareBrand       String?

  // Capacity
  seatsTotal      Int?
  seatsAvailable  Int?
  loadFactor      Float?

  // Data source
  offerId         String?  // Duffel offer ID
  source          String   @default("duffel")
  observedAt      DateTime @default(now())

  @@index([airlineCode])
  @@index([flightNumber])
  @@index([originIata])
  @@index([destinationIata])
  @@index([departureDate])
  @@index([observedAt])
  @@map("flight_records")
}

// Route Statistics (aggregated)
model RouteStatistics {
  id              String   @id @default(cuid())

  // Route
  originIata      String
  destinationIata String
  routeKey        String   @unique // "JFK-LHR"

  // Distance
  distanceKm      Int?
  distanceMiles   Int?
  flightTimeMin   Int?     // Average

  // Carriers
  operatingAirlines String[] // All airlines on route
  carrierCount    Int?
  dominantCarrier String?
  marketShare     Json?    // {"AA": 35, "BA": 30, ...}

  // Frequency
  dailyFlights    Int?
  weeklyFlights   Int?
  seasonality     String?  // "year_round", "seasonal"
  peakMonths      Int[]    // [6, 7, 8]

  // Pricing trends
  avgEconomyPrice Float?
  avgBusinessPrice Float?
  avgFirstPrice   Float?
  priceVolatility Float?   // 0-1 scale
  cheapestMonth   Int?
  expensiveMonth  Int?
  advancePurchase Int?     // Best days in advance

  // Performance
  avgDelay        Float?
  onTimeRate      Float?   // percentage
  cancellationRate Float?

  // Competition
  isCompetitive   Boolean  @default(false)
  hasBudgetOption Boolean  @default(false)

  // Metadata
  lastAnalyzed    DateTime @default(now())
  dataPoints      Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([originIata])
  @@index([destinationIata])
  @@map("route_statistics")
}

// Price Trend Tracking
model PriceTrend {
  id              String   @id @default(cuid())

  // Route
  originIata      String
  destinationIata String
  airlineCode     String?  // null = all airlines

  // Time bucket
  searchDate      DateTime // When price was observed
  departureDate   DateTime // Flight departure date
  daysInAdvance   Int      // Days between search and departure

  // Prices
  economyMin      Float?
  economyAvg      Float?
  economyMax      Float?
  businessMin     Float?
  businessAvg     Float?
  businessMax     Float?
  currency        String   @default("USD")

  // Volume
  offersCount     Int      @default(1)

  // Source
  source          String   @default("duffel")
  createdAt       DateTime @default(now())

  @@index([originIata, destinationIata])
  @@index([searchDate])
  @@index([departureDate])
  @@index([daysInAdvance])
  @@map("price_trends")
}

// Aviation Data Sync Log (extended)
model AviationDataSyncLog {
  id              String   @id @default(cuid())
  entityType      String   // "aircraft", "airport", "fare_class", "flight", "route"
  source          String   // "duffel", "amadeus", "oag", "scraper"
  operation       String   // "create", "update", "bulk_sync"
  status          String   // "success", "partial", "failed"
  recordsProcessed Int     @default(0)
  recordsCreated  Int      @default(0)
  recordsUpdated  Int      @default(0)
  recordsFailed   Int      @default(0)
  errorDetails    Json?
  durationMs      Int?
  metadata        Json?
  createdAt       DateTime @default(now())

  @@index([entityType])
  @@index([source])
  @@index([createdAt])
  @@map("aviation_data_sync_logs")
}

// ==========================================
// Email Marketing System Models
// ==========================================

// Email Log - Track all sent emails
model EmailLog {
  id             String    @id @default(cuid())
  recipientEmail String
  userId         String?
  emailType      String    // transactional, marketing, alert, recovery
  template       String
  event          String?   // trigger event
  subject        String?
  status         String    @default("sent") // sent, delivered, opened, clicked, bounced, complained, failed
  sentAt         DateTime  @default(now())
  deliveredAt    DateTime?
  openedAt       DateTime?
  clickedAt      DateTime?
  opens          Int       @default(0)
  clicks         Int       @default(0)
  bounceType     String?
  bounceReason   String?
  failureReason  String?
  aiDecision     String?
  clientInfo     String?
  geolocation    String?
  metadata       String?
  createdAt      DateTime  @default(now())

  @@index([recipientEmail])
  @@index([userId])
  @@index([sentAt])
  @@index([emailType])
  @@map("email_logs")
}

// Email Decision Log - AI decisions
model EmailDecisionLog {
  id         String   @id @default(cuid())
  email      String
  event      String
  decision   String   // send, delay, skip
  reason     String
  confidence Float?
  metadata   String?
  createdAt  DateTime @default(now())

  @@index([email])
  @@index([createdAt])
  @@map("email_decision_logs")
}

// Scheduled Emails
model ScheduledEmail {
  id           String    @id @default(cuid())
  email        String
  event        String
  payload      String
  scheduledFor DateTime
  status       String    @default("pending") // pending, sent, cancelled
  sentAt       DateTime?
  createdAt    DateTime  @default(now())

  @@index([scheduledFor])
  @@index([status])
  @@map("scheduled_emails")
}

// Campaign Log - Track campaign flows
model CampaignLog {
  id         String   @id @default(cuid())
  campaignId String
  userId     String
  email      String
  event      String   // started, email_sent, completed, converted
  step       Int?
  metadata   String?
  createdAt  DateTime @default(now())

  @@index([campaignId])
  @@index([userId])
  @@map("campaign_logs")
}

// Email Suppression List
model EmailSuppression {
  id        String   @id @default(cuid())
  email     String   @unique
  reason    String   // hard_bounce, complaint, unsubscribed
  details   String?
  createdAt DateTime @default(now())

  @@map("email_suppressions")
}

// ═══════════════════════════════════════════════════════════════════════════════
// SOCIAL MARKETING AUTOMATION SYSTEM
// ═══════════════════════════════════════════════════════════════════════════════

model ContentQueue {
  id            String   @id @default(cuid())
  type          String   // deal, guide, social, blog
  title         String
  content       String   @db.Text
  platforms     String[] // twitter, instagram, facebook, tiktok, blog
  imageUrl      String?
  imagePrompt   String?  @db.Text
  link          String?
  hashtags      String[]
  productType   String?  // flight, hotel, tour, transfer
  productId     String?
  productData   Json?    // Cached product data for the post
  scheduledAt   DateTime
  timezone      String   @default("America/New_York")
  status        String   @default("pending") // pending, processing, posted, failed, cancelled
  priority      Int      @default(0) // Higher = more urgent
  retryCount    Int      @default(0)
  maxRetries    Int      @default(3)
  error         String?  @db.Text
  postedAt      DateTime?
  results       Json?    // Platform-specific post results
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  createdBy     String?  // admin user id or 'system'

  posts         SocialPostLog[]

  @@index([status, scheduledAt])
  @@index([platforms])
  @@index([productType, productId])
  @@map("content_queue")
}

model SocialPostLog {
  id              String   @id @default(cuid())
  contentQueueId  String?
  contentQueue    ContentQueue? @relation(fields: [contentQueueId], references: [id])
  platform        String   // twitter, instagram, facebook, tiktok, blog
  platformPostId  String?  // External post ID from platform
  platformUrl     String?  // URL to the post
  status          String   @default("pending") // pending, posted, failed
  content         String   @db.Text
  imageUrl        String?
  link            String?
  impressions     Int      @default(0)
  engagements     Int      @default(0)
  clicks          Int      @default(0)
  shares          Int      @default(0)
  conversions     Int      @default(0)
  revenue         Decimal  @default(0) @db.Decimal(10, 2)
  error           String?  @db.Text
  metadata        Json?    // Platform-specific metadata
  postedAt        DateTime?
  lastSyncAt      DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([platform, platformPostId])
  @@index([contentQueueId])
  @@index([platform, status])
  @@index([postedAt])
  @@map("social_post_logs")
}
