# üìä Sistema de Logs Detalhados para Email Marketing

## üéØ Vis√£o Geral

Sistema completo de monitoramento e logs estruturados para campanhas de email marketing, fornecendo observabilidade total das opera√ß√µes, m√©tricas em tempo real e alertas inteligentes.

## üèóÔ∏è Arquitetura do Sistema

### üìã Componentes Principais

```
src/lib/
‚îú‚îÄ‚îÄ email-marketing-logger.ts      # Servi√ßo centralizado de logs
‚îú‚îÄ‚îÄ email-marketing-alerts.ts      # Sistema de alertas inteligentes
‚îî‚îÄ‚îÄ email-marketing-db.ts          # Integra√ß√£o com banco de dados

src/app/api/email-marketing/
‚îú‚îÄ‚îÄ route.ts                       # API principal com logging integrado
‚îú‚îÄ‚îÄ logs/route.ts                  # Dashboard de monitoramento
‚îî‚îÄ‚îÄ alerts/route.ts                # Gerenciamento de alertas

src/app/admin/email-marketing/
‚îî‚îÄ‚îÄ monitoring/page.tsx            # Interface de monitoramento

logs/email-marketing/              # Arquivos de log rotativos
‚îú‚îÄ‚îÄ email-marketing-2024-01-15.jsonl
‚îú‚îÄ‚îÄ email-marketing-2024-01-16.jsonl
‚îî‚îÄ‚îÄ ...
```

## üîß Funcionalidades Implementadas

### ‚úÖ 1. Logger Centralizado (EmailMarketingLogger)

**Caracter√≠sticas:**
- ‚ú® Logs estruturados em formato JSON Lines
- üìÅ Rota√ß√£o autom√°tica de arquivos (di√°ria/semanal/mensal)
- üéöÔ∏è 5 n√≠veis de log: DEBUG, INFO, WARN, ERROR, CRITICAL
- üíæ Sa√≠da simult√¢nea para console e arquivo
- üßπ Limpeza autom√°tica de logs antigos
- üìä M√©tricas de performance integradas

**Eventos Monitorados:**
- `CAMPAIGN_CREATED` - Cria√ß√£o de campanhas
- `CAMPAIGN_STARTED` - In√≠cio de processamento
- `CAMPAIGN_COMPLETED` - Finaliza√ß√£o bem-sucedida
- `CAMPAIGN_FAILED` - Falhas de campanha
- `BATCH_STARTED/COMPLETED` - Processamento em lotes
- `EMAIL_SENT/FAILED` - Status de envios individuais
- `RETRY_SCHEDULED/ATTEMPTED` - Sistema de retry
- `RATE_LIMITED` - Controle de taxa de envio
- `HEARTBEAT` - Monitoramento de sa√∫de
- `SYSTEM_ERROR` - Erros do sistema

### ‚úÖ 2. Sistema de Alertas Inteligentes

**Regras de Alerta Padr√£o:**
- üö® **Taxa de Falha Alta** - >20% em 15 minutos
- ‚è∞ **Campanha Travada** - Sem heartbeat por 10 minutos
- üî¥ **Erros Cr√≠ticos** - Qualquer erro CRITICAL
- ‚ö° **Rate Limit Excessivo** - >5 ocorr√™ncias em 30 minutos
- üìß **Bounces em Massa** - >10% bounce rate em 60 minutos
- üîë **Falha de Credenciais** - Erro de autentica√ß√£o

**A√ß√µes Autom√°ticas:**
- üîî Notifica√ß√µes em tempo real
- ‚è∏Ô∏è Pausar campanhas problem√°ticas
- üìß Envio de alertas via email
- ü™ù Webhooks para integra√ß√£o externa

### ‚úÖ 3. Dashboard de Monitoramento

**M√©tricas em Tempo Real:**
- üìà Vis√£o geral do sistema
- üö® Alertas ativos e hist√≥rico
- üìä Logs em tempo real
- üéØ Performance por campanha
- üíª M√©tricas de sistema (CPU, mem√≥ria)

**Funcionalidades do Dashboard:**
- üîÑ Auto-refresh configur√°vel
- üìÖ Filtros por per√≠odo de tempo
- üì• Exporta√ß√£o de logs (CSV/JSON)
- ‚úÖ Gerenciamento de alertas
- üì± Interface responsiva

## üì° APIs Dispon√≠veis

### üîç Logs API (`/api/email-marketing/logs`)

**GET Endpoints:**
```javascript
// Dashboard principal
GET /api/email-marketing/logs?action=dashboard&hours=24

// Logs em tempo real
GET /api/email-marketing/logs?action=realtime

// Logs espec√≠ficos de campanha
GET /api/email-marketing/logs?action=campaigns&campaignId=xyz&hours=24

// Alertas do sistema
GET /api/email-marketing/logs?action=alerts&level=error&hours=1

// M√©tricas de performance
GET /api/email-marketing/logs?action=performance&hours=24

// Exportar logs
GET /api/email-marketing/logs?action=export&format=csv&hours=24

// Limpeza de logs antigos
GET /api/email-marketing/logs?action=cleanup
```

**POST Endpoints:**
```javascript
// Criar log de teste
POST /api/email-marketing/logs
{
  "action": "test_log",
  "level": "info",
  "event": "test_event",
  "message": "Test message",
  "campaignId": "test-campaign"
}

// For√ßar limpeza
POST /api/email-marketing/logs
{
  "action": "force_cleanup"
}
```

### üö® Alerts API (`/api/email-marketing/alerts`)

**GET Endpoints:**
```javascript
// Listar alertas
GET /api/email-marketing/alerts?action=list&level=error&hours=24

// Estat√≠sticas de alertas
GET /api/email-marketing/alerts?action=statistics&hours=24

// Regras de alerta
GET /api/email-marketing/alerts?action=rules

// Alertas ativos
GET /api/email-marketing/alerts?action=active

// Dashboard de alertas
GET /api/email-marketing/alerts?action=dashboard
```

**POST Endpoints:**
```javascript
// Reconhecer alerta
POST /api/email-marketing/alerts
{
  "action": "acknowledge",
  "alertId": "alert-123"
}

// Resolver alerta
POST /api/email-marketing/alerts
{
  "action": "resolve",
  "alertId": "alert-123"
}

// Criar regra personalizada
POST /api/email-marketing/alerts
{
  "action": "create_rule",
  "name": "Custom Rule",
  "description": "Custom alert rule",
  "enabled": true,
  "conditions": {
    "event": "EMAIL_FAILED",
    "threshold": 0.15,
    "timeWindow": 30
  },
  "actions": {
    "notify": true,
    "pauseCampaign": true
  }
}
```

## üöÄ Como Usar

### 1. Integra√ß√£o B√°sica

```typescript
import { emailMarketingLogger, EmailEvent } from '@/lib/email-marketing-logger';

// Log de sucesso
emailMarketingLogger.logEmailSuccess(
  campaignId, 
  contactId, 
  email, 
  { messageId, processingTime: 1200 }
);

// Log de falha
emailMarketingLogger.logEmailFailure(
  campaignId, 
  contactId, 
  email, 
  error, 
  { retryCount: 2, willRetry: true }
);

// Log de m√©tricas de campanha
emailMarketingLogger.logCampaignMetrics(campaignId, {
  totalEmails: 1000,
  successCount: 950,
  failureCount: 50,
  successRate: 95,
  duration: 180000
});
```

### 2. Configura√ß√£o de Alertas

```typescript
import { emailMarketingAlerts } from '@/lib/email-marketing-alerts';

// Subscrever alertas
const unsubscribe = emailMarketingAlerts.subscribe((alert) => {
  console.log('New alert:', alert);
  // Enviar notifica√ß√£o, webhook, etc.
});

// Criar regra personalizada
const ruleId = emailMarketingAlerts.addRule({
  name: 'High Bounce Rate',
  description: 'Alert when bounce rate exceeds 15%',
  enabled: true,
  conditions: {
    event: EmailEvent.EMAIL_BOUNCED,
    threshold: 0.15,
    timeWindow: 60
  },
  actions: {
    notify: true,
    pauseCampaign: true,
    webhook: 'https://hooks.slack.com/...'
  }
});
```

### 3. Monitoramento via Dashboard

1. Acesse: `/admin/email-marketing/monitoring`
2. Configure auto-refresh e per√≠odo de tempo
3. Monitore m√©tricas em tempo real
4. Gerencie alertas ativos
5. Exporte logs para an√°lise

## üìä Estrutura dos Logs

### Formato JSON Lines

```json
{
  "timestamp": "2024-01-15T10:30:45.123Z",
  "level": 1,
  "levelName": "INFO",
  "campaignId": "campaign_1705315845_abc123",
  "contactId": "contact_1705315845_xyz789",
  "email": "user@example.com",
  "event": "EMAIL_SENT",
  "message": "Email sent successfully",
  "metadata": {
    "messageId": "abc123@gmail.com",
    "retryCount": 0,
    "timestamp": "2024-01-15T10:30:45.123Z"
  },
  "duration": 1200,
  "performance": {
    "memoryUsage": {
      "heapUsed": 45678912,
      "heapTotal": 67108864
    },
    "processingTime": 1200
  }
}
```

### Campos Principais

- **timestamp**: ISO timestamp do evento
- **level**: N√≠vel num√©rico (0=DEBUG, 4=CRITICAL)
- **levelName**: Nome do n√≠vel (DEBUG, INFO, WARN, ERROR, CRITICAL)
- **event**: Tipo de evento (enum EmailEvent)
- **message**: Descri√ß√£o leg√≠vel do evento
- **campaignId**: ID da campanha (se aplic√°vel)
- **contactId**: ID do contato (se aplic√°vel)
- **email**: Endere√ßo de email (se aplic√°vel)
- **metadata**: Dados adicionais espec√≠ficos do evento
- **duration**: Tempo de processamento em ms
- **error**: Detalhes do erro (se aplic√°vel)
- **performance**: M√©tricas de performance do sistema

## ‚ö° Performance e Otimiza√ß√£o

### Configura√ß√µes Recomendadas

```typescript
// Logger de produ√ß√£o
const logger = new EmailMarketingLogger({
  logDir: '/var/log/email-marketing',
  maxFileSize: 100, // 100MB
  maxFiles: 30,     // 30 dias
  enableConsole: false,
  enableFile: true,
  logLevel: LogLevel.INFO,
  rotationInterval: 'daily'
});

// Logger de desenvolvimento
const logger = new EmailMarketingLogger({
  logLevel: LogLevel.DEBUG,
  enableConsole: true,
  rotationInterval: 'daily'
});
```

### Otimiza√ß√µes Implementadas

- ‚úÖ **Escrita ass√≠ncrona** - N√£o bloqueia processamento
- ‚úÖ **Compress√£o autom√°tica** - Logs antigos comprimidos
- ‚úÖ **Rate limiting inteligente** - Evita spam de logs
- ‚úÖ **Cleanup autom√°tico** - Remove logs antigos
- ‚úÖ **Buffering eficiente** - Agrupa escritas para performance

## üõ°Ô∏è Monitoramento de Produ√ß√£o

### M√©tricas Cr√≠ticas

1. **Taxa de Erro** - Manter < 5%
2. **Tempo de Resposta** - M√©dia < 2 segundos
3. **Memory Usage** - Manter < 80% da heap
4. **Heartbeat** - Sem falhas > 5 minutos
5. **Rate Limiting** - Ocorr√™ncias < 10/hora

### Alertas Cr√≠ticos

- üî• **Sistema Down** - Sem heartbeat por 10+ minutos
- üö® **Taxa de Falha** - >20% em 15 minutos
- üí• **Memory Leak** - Crescimento constante por 1+ hora
- ‚ö° **Rate Limit** - >5 ocorr√™ncias em 30 minutos

### A√ß√µes de Emerg√™ncia

```bash
# Verificar logs cr√≠ticos
curl "https://fly2any.com/api/email-marketing/logs?action=alerts&level=critical&hours=1"

# Pausar todas as campanhas
curl -X POST "https://fly2any.com/api/email-marketing" \
  -H "Content-Type: application/json" \
  -d '{"action": "pause_all_campaigns"}'

# Exportar logs para an√°lise
curl "https://fly2any.com/api/email-marketing/logs?action=export&format=csv&hours=24" > emergency-logs.csv

# Reiniciar sistema de alertas
curl -X POST "https://fly2any.com/api/email-marketing/alerts" \
  -d '{"action": "restart_alert_system"}'
```

## üîÆ An√°lises Avan√ßadas

### Consultas √öteis

```javascript
// Taxa de sucesso por per√≠odo
const successRate = await fetch('/api/email-marketing/logs?action=performance&hours=24')
  .then(r => r.json())
  .then(data => data.data.overview.successRate);

// Campanhas com problemas
const problemCampaigns = await fetch('/api/email-marketing/logs?action=campaigns&hours=24')
  .then(r => r.json())
  .then(data => data.data.filter(c => c.errorRate > 0.1));

// Tend√™ncia de alertas
const alertTrend = await fetch('/api/email-marketing/alerts?action=statistics&hours=168')
  .then(r => r.json())
  .then(data => data.data.statistics.byLevel);
```

### Relat√≥rios Automatizados

```javascript
// Relat√≥rio di√°rio via cron
// 0 9 * * * curl "https://fly2any.com/api/email-marketing/logs?action=daily_report"

// Relat√≥rio semanal
// 0 9 * * 1 curl "https://fly2any.com/api/email-marketing/logs?action=weekly_report"
```

## üéâ Benef√≠cios Alcan√ßados

### ‚úÖ Observabilidade Total
- üëÅÔ∏è Visibilidade completa de todas as opera√ß√µes
- üìä M√©tricas detalhadas por campanha e contato
- üîç Rastreamento de falhas e sucessos
- ‚è±Ô∏è Medi√ß√£o precisa de performance

### ‚úÖ Alertas Inteligentes
- üö® Detec√ß√£o proativa de problemas
- ü§ñ A√ß√µes autom√°ticas de mitiga√ß√£o
- üì± Notifica√ß√µes em tempo real
- üìà Redu√ß√£o de downtime

### ‚úÖ An√°lise Avan√ßada
- üìä Dashboards interativos
- üìà Tend√™ncias hist√≥ricas
- üéØ Otimiza√ß√£o baseada em dados
- üìã Relat√≥rios automatizados

### ‚úÖ Confiabilidade
- üõ°Ô∏è Monitoramento 24/7
- üîÑ Auto-recovery de campanhas
- üìù Auditoria completa
- üöÄ Alta disponibilidade

---

## üìû Suporte

Para d√∫vidas ou problemas:

1. **Dashboard**: `/admin/email-marketing/monitoring`
2. **Logs em Tempo Real**: Aba "Live Logs"
3. **Alertas Ativos**: Aba "Alerts"
4. **Documenta√ß√£o**: Este arquivo

---

**üéØ Sistema de Logs Implementado com Sucesso!**

‚úÖ Logging estruturado e rotativo  
‚úÖ Alertas inteligentes e autom√°ticos  
‚úÖ Dashboard de monitoramento em tempo real  
‚úÖ APIs completas para integra√ß√£o  
‚úÖ Performance otimizada para produ√ß√£o  

*Monitoramento profissional para campanhas de email marketing de alta performance!* üöÄ